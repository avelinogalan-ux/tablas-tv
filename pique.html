<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Puntuaci√≥n - Visor</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéØ</text></svg>">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { 
            background: radial-gradient(circle at center, #000428 0%, #004e92 100%); 
            color: #fff; 
            font-family: 'Rajdhani', sans-serif; 
            margin:0; 
            padding:0; 
            min-height: 100vh;
        }
        
        .header {
            position: relative;
            background: linear-gradient(90deg, #002bff 0%, #001242 100%);
            padding: 1.5rem 1rem;
            border-bottom: 0.5vh solid #ffc107;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        .logo-izquierdo { 
            position: absolute; 
            left: 1rem; 
            top: 50%;
            transform: translateY(-50%);
            height: 60px; 
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.7)); 
        }
        
        .header h1 {
            font-size: clamp(1.8rem, 5vw, 3rem);
            margin: 0;
            text-transform: uppercase;
            text-shadow: 0 0 25px rgba(255,255,255,0.9);
            text-align: center;
        }
        
        .disciplina-badge {
            text-align: center;
            margin-top: 0.5rem;
            font-size: clamp(1rem, 3vw, 1.3rem);
            color: #00d8ff;
            text-shadow: 0 0 10px rgba(0,216,255,0.5);
        }
        
        .status-box {
            max-width: 90%;
            margin: 1rem auto;
            padding: 0.7rem;
            border-radius: 0.5rem;
            font-size: clamp(0.9rem, 2.5vw, 1.2rem);
            font-weight: bold;
            text-align: center;
        }
        
        .status-connected {
            background: rgba(0,255,136,0.2);
            border: 2px solid #00ff88;
            color: #00ff88;
            text-shadow: 0 0 15px rgba(0,255,136,0.7);
        }
        
        .status-disconnected {
            background: rgba(255,0,60,0.2);
            border: 2px solid #ff003c;
            color: #ff4d6d;
        }
        
        .container-main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .card-tirador {
            background: linear-gradient(135deg, rgba(255,193,7,0.2) 0%, rgba(255,152,0,0.15) 100%);
            border: 4px solid #ffc107;
            border-radius: 15px;
            padding: 2rem 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 0 40px rgba(255,193,7,0.4);
            animation: pulseGlow 3s infinite;
            backdrop-filter: blur(10px);
        }
        
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 40px rgba(255,193,7,0.4); }
            50% { box-shadow: 0 0 60px rgba(255,193,7,0.7); }
        }
        
        .posicion-grande {
            display: inline-block;
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: #000;
            font-size: clamp(3rem, 10vw, 5rem);
            font-weight: 900;
            padding: 1rem 2rem;
            border-radius: 15px;
            margin-bottom: 1rem;
            text-shadow: 0 3px 6px rgba(0,0,0,0.3);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        
        .nombre-principal {
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            font-weight: 700;
            margin: 1rem 0;
            color: #ffc107;
            text-transform: uppercase;
            text-shadow: 0 0 20px rgba(255,193,7,0.7);
        }
        
        .tabla-mi-puesto {
            width: 100%;
            background: rgba(0,60,150,0.3);
            border: 2px solid #00bfff;
            border-radius: 10px;
            backdrop-filter: blur(8px);
            overflow: hidden;
        }
        
        .tabla-mi-puesto thead {
            background: linear-gradient(90deg, #001f7a 0%, #0048ff 100%);
        }
        
        .tabla-mi-puesto th {
            padding: 0.8rem 0.4rem;
            text-align: center;
            font-size: clamp(0.9rem, 2.5vw, 1.3rem);
            text-transform: uppercase;
            border-bottom: 3px solid #ffc107;
        }
        
        .tabla-mi-puesto td {
            padding: 0.8rem 0.4rem;
            text-align: center;
            font-size: clamp(1rem, 3vw, 1.5rem);
            font-weight: 700;
        }
        
        .stat-total-grande {
            background-color: rgba(0,255,136,0.3) !important;
            color: #00ff9c;
            font-size: clamp(1.5rem, 4vw, 2.5rem) !important;
        }
        
        .stat-x-grande {
            background-color: rgba(0,229,255,0.3) !important;
            color: #00d8ff;
            font-size: clamp(1.5rem, 4vw, 2.5rem) !important;
        }
        
        .seccion-rivales {
            margin-top: 2rem;
        }
        
        .seccion-rivales h3 {
            font-size: clamp(1.3rem, 4vw, 2rem);
            color: #00d8ff;
            text-transform: uppercase;
            text-shadow: 0 0 15px rgba(0,216,255,0.7);
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .card-rival {
            background: rgba(0,60,150,0.2);
            border: 3px solid #007bff;
            border-radius: 12px;
            padding: 1.5rem 1rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 0 20px rgba(0,123,255,0.3);
            backdrop-filter: blur(8px);
        }
        
        .rival-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(0,123,255,0.5);
        }
        
        .posicion-rival {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: #fff;
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            font-weight: 900;
            padding: 0.5rem 1rem;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .nombre-rival {
            font-size: clamp(1.1rem, 3.5vw, 1.6rem);
            font-weight: 700;
            color: #00d8ff;
            text-transform: uppercase;
        }
        
        .diferencia-puntos {
            font-size: clamp(0.9rem, 2.5vw, 1.2rem);
            font-weight: 700;
            margin-top: 0.3rem;
        }
        
        .diferencia-positiva { color: #ff4d6d; }
        .diferencia-negativa { color: #00ff9c; }
        
        .tabla-rival {
            width: 100%;
            background: rgba(0,40,100,0.2);
            border: 1px solid rgba(0,123,255,0.3);
            border-radius: 8px;
        }
        
        .tabla-rival th {
            background: rgba(0,60,150,0.4);
            padding: 0.6rem 0.3rem;
            text-align: center;
            font-size: clamp(0.8rem, 2vw, 1rem);
            text-transform: uppercase;
            border-bottom: 2px solid rgba(0,123,255,0.5);
        }
        
        .tabla-rival td {
            padding: 0.6rem 0.3rem;
            text-align: center;
            font-size: clamp(0.9rem, 2.5vw, 1.2rem);
            font-weight: 600;
        }
        
        .tabla-rival .stat-total {
            background-color: rgba(0,255,136,0.2);
            color: #00ff9c;
            font-weight: 700;
        }
        
        .tabla-rival .stat-x {
            background-color: rgba(0,229,255,0.2);
            color: #00d8ff;
            font-weight: 700;
        }
        
        .btn-reconfigurar { display: none; } /* Oculto en la versi√≥n para tiradores */
        
        .update-info {
            text-align: center;
            color: #00e6ff;
            font-size: clamp(0.8rem, 2vw, 1rem);
            margin-top: 1.5rem;
            text-shadow: 0 0 8px rgba(0,230,255,0.9);
        }
        
        .loading-area {
            text-align: center;
            padding: 4rem 1rem;
        }
        
        .spinner {
            display: inline-block;
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,193,7,0.3);
            border-top: 5px solid #ffc107;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .loading-text {
            margin-top: 1.5rem;
            font-size: clamp(1rem, 3vw, 1.5rem);
            color: #ffc107;
        }
        
        .sin-rivales {
            background: rgba(255,255,255,0.05);
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            color: #aaa;
            font-size: clamp(0.9rem, 2.5vw, 1.1rem);
        }

        @media (max-width: 768px) {
            .header h1 { font-size: clamp(1.5rem, 6vw, 2rem); }
            .logo-izquierdo { height: 45px; }
            .container-main { padding: 0 0.5rem; }
            .card-tirador, .card-rival { padding: 1rem; }
            .nombre-principal { font-size: clamp(1.3rem, 5vw, 2rem); }
            .tabla-mi-puesto thead, .tabla-rival thead { display: none; }
            .tabla-mi-puesto, .tabla-rival, .tabla-mi-puesto tbody, .tabla-rival tbody, .tabla-mi-puesto tr, .tabla-rival tr {
                display: block;
                width: 100%;
            }
            .tabla-mi-puesto td, .tabla-rival td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                text-align: right;
                padding: 0.8rem;
                border-bottom: 1px solid rgba(0, 191, 255, 0.2);
            }
            .tabla-mi-puesto td:last-child, .tabla-rival td:last-child { border-bottom: none; }
            .tabla-mi-puesto td::before, .tabla-rival td::before {
                content: attr(data-label);
                font-weight: 600;
                color: #00d8ff;
                text-align: left;
                padding-right: 1rem;
            }
            .stat-total-grande, .stat-x-grande, .tabla-rival .stat-total, .tabla-rival .stat-x {
                font-size: 1.5rem !important;
            }
        }
        
        @media (max-width: 480px) {
            .header { padding: 1rem 0.5rem; }
            .posicion-grande { font-size: 2rem; padding: 0.3rem 0.6rem; margin-bottom: 0.5rem; }
            .posicion-rival { font-size: 1.2rem; padding: 0.2rem 0.5rem; }
            .nombre-rival { font-size: 1.2rem; }
        }
    </style>
</head>
<body>

<!-- Modal de Acceso por Puesto y PIN -->
<div class="modal fade" id="modalConfigVisor" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white" style="backdrop-filter: blur(10px); background: rgba(0,20,50,0.95) !important; border: 3px solid #007bff;">
      <div class="modal-header" style="border-bottom: 3px solid #ffc107;">
        <h5 class="modal-title" style="font-size: 1.5rem;"><i class="bi bi-shield-lock-fill"></i> Acceso Tirador</h5>
      </div>
      <div class="modal-body">
        <div class="mb-4">
          <label class="form-label fw-bold" style="font-size: 1.1rem;">üë§ Tu N√∫mero de Puesto</label>
          <input type="number" id="miPuestoInput" class="form-control form-control-lg text-center" placeholder="Ej: 7" required style="background: rgba(255,255,255,0.1); border: 2px solid #ffc107; color: #fff; font-size: 1.5rem;">
        </div>
        <div class="mb-4">
          <label class="form-label fw-bold" style="font-size: 1.1rem;">üîê Tu PIN Secreto (4 d√≠gitos)</label>
          <input type="password" id="miPinInput" class="form-control form-control-lg text-center" maxlength="4" inputmode="numeric" pattern="[0-9]*" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required style="background: rgba(255,255,255,0.1); border: 2px solid #007bff; color: #fff; font-size: 1.5rem;">
        </div>
        <h6 class="text-white-50 mt-4">¬øQuieres seguir a alg√∫n rival? (Opcional)</h6>
        <div class="mb-4">
          <label class="form-label fw-bold" style="font-size: 1.1rem;">üéØ Rival 1</label>
          <select id="rival1" class="form-select" disabled style="background: rgba(128,128,128,0.1); border: 2px solid #6c757d; color: #6c757d;">
            <option value="">-- Valida tu PIN primero --</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="form-label fw-bold" style="font-size: 1.1rem;">üéØ Rival 2</label>
          <select id="rival2" class="form-select" disabled style="background: rgba(128,128,128,0.1); border: 2px solid #6c757d; color: #6c757d;">
            <option value="">-- Valida tu PIN primero --</option>
          </select>
        </div>
        <button class="btn w-100" onclick="validarYComenzar()" style="background: linear-gradient(90deg, #ffc107, #ff9800); border: none; color: #000; font-weight: 700; font-size: 1.2rem; padding: 0.8rem;">
          <i class="bi bi-box-arrow-in-right"></i> Entrar
        </button>
        <div id="errorConfig" class="text-danger text-center mt-3 fw-bold" style="min-height: 24px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Contenido Principal -->
<div id="mainContent" style="display: none;">
  <div class="header">
    <img src="shooting_logo.png" alt="Logo" class="logo-izquierdo" onerror="this.style.display='none'">
    <h1><i class="bi bi-bullseye"></i> Mi Puntuaci√≥n</h1>
    <div class="disciplina-badge" id="disciplinaName"></div>
  </div>
  <div class="status-box status-connected" id="statusBox">
    <i class="bi bi-wifi"></i> Conectado
  </div>
  <div class="container-main">
    <div id="loadingArea" class="loading-area">
      <div class="spinner"></div>
      <p class="loading-text">Cargando resultados...</p>
    </div>
    <div id="contentArea" style="display: none;">
      <div id="miCard" class="card-tirador"></div>
      <div class="seccion-rivales">
        <h3><i class="bi bi-eye-fill"></i> Rivales Seguidos</h3>
        <div id="rival1Card"></div>
        <div id="rival2Card"></div>
        <div id="sinRivales" style="display: none;" class="sin-rivales">
          <i class="bi bi-info-circle" style="font-size: 2rem; color: #007bff;"></i>
          <p class="mt-2">No has seleccionado rivales.</p>
        </div>
      </div>
      <div class="update-info" id="updateInfo"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const DATOS_COMPETICION_BIN_ID = '68ed56de43b1c97be96636cc'; // <-- ¬°¬°IMPORTANTE!! Cambia esto por el ID de tu Bin
    const INTERVALO_ACTUALIZACION = 10000;
    
    let modalConfigVisor;
    let datosCompletos = null;
    let configuracion = { miPuesto: null, rival1: null, rival2: null };
    let intervaloActualizacion;

    document.addEventListener('DOMContentLoaded', () => {
        modalConfigVisor = new bootstrap.Modal('#modalConfigVisor');
        modalConfigVisor.show();
    });

    async function validarYComenzar() {
        const miPuestoInput = document.getElementById('miPuestoInput').value.trim();
        const miPinInput = document.getElementById('miPinInput').value.trim();
        const errorDiv = document.getElementById('errorConfig');
        errorDiv.textContent = '';

        if (!miPuestoInput || !miPinInput || miPinInput.length !== 4) {
            errorDiv.textContent = 'Debes introducir tu puesto y un PIN de 4 d√≠gitos.';
            return;
        }

        try {
            const response = await fetch(`https://api.jsonbin.io/v3/b/${DATOS_COMPETICION_BIN_ID}/latest`);
            datosCompletos = (await response.json()).record;

            const tiradorValidado = datosCompletos.datos.find(
                t => String(t.puesto) === miPuestoInput && String(t.pin) === miPinInput
            );

            if (!tiradorValidado) {
                errorDiv.textContent = 'Puesto o PIN incorrecto. Int√©ntalo de nuevo.';
                return;
            }

            poblarSelectoresRivales(datosCompletos.datos, miPuestoInput);
            
            // Recoger selecci√≥n de rivales DESPU√âS de poblar y antes de iniciar
            configuracion = {
                miPuesto: miPuestoInput,
                rival1: document.getElementById('rival1').value || null,
                rival2: document.getElementById('rival2').value || null
            }
            
            modalConfigVisor.hide();
            document.getElementById('mainContent').style.display = 'block';
            iniciarSeguimiento();

        } catch (error) {
            console.error('Error de validaci√≥n:', error);
            errorDiv.textContent = 'Error de conexi√≥n con el servidor.';
        }
    }

    function poblarSelectoresRivales(datos, miPuesto) {
        const selectRival1 = document.getElementById('rival1');
        const selectRival2 = document.getElementById('rival2');
        
        selectRival1.disabled = false;
        selectRival2.disabled = false;
        selectRival1.style.background = "rgba(255,255,255,0.1)"; selectRival1.style.color = "#fff";
        selectRival2.style.background = "rgba(255,255,255,0.1)"; selectRival2.style.color = "#fff";
        
        selectRival1.innerHTML = '<option value="">-- No seguir a nadie --</option>';
        selectRival2.innerHTML = '<option value="">-- No seguir a nadie --</option>';
        
        datos.sort((a, b) => a.puesto - b.puesto).forEach(tirador => {
            if (String(tirador.puesto) !== String(miPuesto)) {
                const option = `<option value="${tirador.puesto}">Puesto ${tirador.puesto}</option>`;
                selectRival1.innerHTML += option;
                selectRival2.innerHTML += option;
            }
        });
    }

    function iniciarSeguimiento() {
        cargarYMostrarDatos();
        if (intervaloActualizacion) clearInterval(intervaloActualizacion);
        intervaloActualizacion = setInterval(cargarYMostrarDatos, INTERVALO_ACTUALIZACION);
    }
    
    async function cargarYMostrarDatos() {
        try {
            // Actualizar la selecci√≥n de rivales en cada ciclo, por si el usuario los cambia
            configuracion.rival1 = document.getElementById('rival1').value || null;
            configuracion.rival2 = document.getElementById('rival2').value || null;

            const response = await fetch(`https://api.jsonbin.io/v3/b/${DATOS_COMPETICION_BIN_ID}/latest`);
            const data = (await response.json()).record;

            document.getElementById('disciplinaName').textContent = data.disciplina || 'Competici√≥n en Directo';
            document.getElementById('statusBox').className = 'status-box status-connected';
            document.getElementById('statusBox').innerHTML = '<i class="bi bi-check-circle-fill"></i> EN DIRECTO';
            if (data.datos && data.datos.length > 0) {
                mostrarDatos(data.datos);
                document.getElementById('loadingArea').style.display = 'none';
                document.getElementById('contentArea').style.display = 'block';
            }
            const ahora = new Date();
            document.getElementById('updateInfo').innerHTML = `<i class="bi bi-clock-fill"></i> Actualizado: ${ahora.toLocaleTimeString()}`;
        } catch (error) {
            console.error('Error cargando datos:', error);
            document.getElementById('statusBox').className = 'status-box status-disconnected';
            document.getElementById('statusBox').innerHTML = '<i class="bi bi-wifi-off"></i> SIN CONEXI√ìN';
        }
    }
    
    function mostrarDatos(datos) {
        const miDatos = datos.find(t => String(t.puesto) === String(configuracion.miPuesto));
        const rival1Datos = configuracion.rival1 ? datos.find(t => String(t.puesto) === String(configuracion.rival1)) : null;
        const rival2Datos = configuracion.rival2 ? datos.find(t => String(t.puesto) === String(configuracion.rival2)) : null;
        const clasificacion = [...datos].sort((a, b) => (b.total || 0) - (a.total || 0));
        
        if (!miDatos) {
            console.error("No se encontraron los datos del puesto configurado. Recargando...");
            location.reload();
            return;
        }

        const miPosicion = clasificacion.findIndex(t => String(t.puesto) === String(configuracion.miPuesto)) + 1;
        
        document.getElementById('miCard').innerHTML = crearCardPrincipal(miDatos, miPosicion);
        
        let hayRivales = false;
        if (rival1Datos) {
            const posRival1 = clasificacion.findIndex(t => String(t.puesto) === String(configuracion.rival1)) + 1;
            document.getElementById('rival1Card').innerHTML = crearCardRival(rival1Datos, posRival1, 1, miDatos.total);
            hayRivales = true;
        } else {
            document.getElementById('rival1Card').innerHTML = '';
        }
        
        if (rival2Datos) {
            const posRival2 = clasificacion.findIndex(t => String(t.puesto) === String(configuracion.rival2)) + 1;
            document.getElementById('rival2Card').innerHTML = crearCardRival(rival2Datos, posRival2, 2, miDatos.total);
            hayRivales = true;
        } else {
            document.getElementById('rival2Card').innerHTML = '';
        }
        
        document.getElementById('sinRivales').style.display = hayRivales ? 'none' : 'block';
    }

    function crearCardPrincipal(datos, posicion) {
        const series = datos.series || [];
        return `
            <div class="text-center">
                <div class="posicion-grande">${posicion}¬∫</div>
                <div class="nombre-principal">Puesto ${datos.puesto}</div>
            </div>
            <table class="tabla-mi-puesto">
                <thead><tr>${series.map((_, i) => `<th>S${i+1}</th>`).join('')}<th>Total</th><th>X</th></tr></thead>
                <tbody>
                    <tr>
                        ${series.map((s, i) => `<td data-label="S${i+1}">${s !== null ? s : '-'}</td>`).join('')}
                        <td class="stat-total-grande" data-label="Total">${datos.total || 0}</td>
                        <td class="stat-x-grande" data-label="X">${datos.xTotal || 0}</td>
                    </tr>
                </tbody>
            </table>`;
    }

    function crearCardRival(datos, posicion, numeroRival, miTotal) {
        const series = datos.series || [];
        const diferencia = datos.total - miTotal;
        const textoDiferencia = diferencia > 0 ? `+${diferencia}` : diferencia;
        const claseDiferencia = diferencia >= 0 ? 'diferencia-positiva' : 'diferencia-negativa';
        return `
            <div class="card-rival">
                <div class="rival-header">
                    <div>
                        <div class="nombre-rival">Rival ${numeroRival} - Puesto ${datos.puesto}</div>
                        <div class="diferencia-puntos ${claseDiferencia}">${diferencia >= 0 ? '‚ñ≤' : '‚ñº'} ${textoDiferencia} puntos</div>
                    </div>
                    <div class="posicion-rival">${posicion}¬∫</div>
                </div>
                <table class="tabla-rival">
                    <thead><tr>${series.map((_, i) => `<th>S${i+1}</th>`).join('')}<th>Total</th><th>X</th></tr></thead>
                    <tbody>
                        <tr>
                            ${series.map((s, i) => `<td data-label="S${i+1}">${s !== null ? s : '-'}</td>`).join('')}
                            <td class="stat-total" data-label="Total">${datos.total || 0}</td>
                            <td class="stat-x" data-label="X">${datos.xTotal || 0}</td>
                        </tr>
                    </tbody>
                </table>
            </div>`;
    }
    
    window.addEventListener('beforeunload', () => {
        if (intervaloActualizacion) clearInterval(intervaloActualizacion);
    });
</script>

</body>
</html>
