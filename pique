<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Seguimiento - Resultados</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22></text></svg>">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { 
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%); 
            color: #fff; 
            font-family: 'Rajdhani', sans-serif; 
            margin:0; 
            padding:0; 
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(90deg, #001f3f 0%, #003d7a 100%);
            padding: 1rem;
            text-align: center;
            border-bottom: 3px solid #ffc107;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        .header h1 {
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            margin: 0;
            text-transform: uppercase;
            text-shadow: 0 0 15px rgba(255,255,255,0.5);
        }
        
        .status-indicator {
            display: inline-block;
            margin-top: 0.5rem;
            padding: 0.3rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .status-connected {
            background: rgba(0,255,136,0.2);
            border: 2px solid #00ff88;
            color: #00ff88;
        }
        
        .status-disconnected {
            background: rgba(255,77,109,0.2);
            border: 2px solid #ff4d6d;
            color: #ff4d6d;
        }
        
        .container-main {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        /* CARD PRINCIPAL (MI PUESTO) */
        .card-tirador {
            background: linear-gradient(135deg, rgba(255,193,7,0.15) 0%, rgba(255,152,0,0.1) 100%);
            border: 3px solid #ffc107;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 20px rgba(255,193,7,0.3);
            animation: pulseGlow 3s infinite;
        }
        
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 8px 20px rgba(255,193,7,0.3); }
            50% { box-shadow: 0 8px 30px rgba(255,193,7,0.6); }
        }
        
        .card-tirador .puesto-badge {
            display: inline-block;
            background: #ffc107;
            color: #000;
            font-size: clamp(2rem, 8vw, 4rem);
            font-weight: 900;
            padding: 0.5rem 1.5rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .card-tirador .nombre-tirador {
            font-size: clamp(1.3rem, 4vw, 2rem);
            font-weight: 700;
            margin-bottom: 1rem;
            color: #ffc107;
        }
        
        /* CARDS DE RIVALES */
        .card-rival {
            background: rgba(0,123,255,0.1);
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 10px rgba(0,123,255,0.2);
        }
        
        .card-rival .rival-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .card-rival .puesto-small {
            background: #007bff;
            color: #fff;
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            font-weight: 700;
            padding: 0.3rem 0.8rem;
            border-radius: 8px;
        }
        
        .card-rival .nombre-rival {
            font-size: clamp(1rem, 3vw, 1.3rem);
            font-weight: 600;
            color: #00d8ff;
        }
        
        /* STATS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.8rem;
            margin-top: 1rem;
        }
        
        .stat-item {
            background: rgba(255,255,255,0.05);
            padding: 0.8rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #aaa;
            text-transform: uppercase;
            margin-bottom: 0.3rem;
        }
        
        .stat-value {
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            font-weight: 700;
        }
        
        .stat-total {
            color: #00ff9c;
        }
        
        .stat-x {
            color: #00d8ff;
        }
        
        /* SERIES */
        .series-container {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        
        .serie-badge {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            padding: 0.5rem 0.8rem;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
        }
        
        /* SECCIN DE CONFIGURACIN */
        .config-section {
            background: rgba(0,0,0,0.3);
            border: 2px solid #666;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .config-section h3 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: #ffc107;
        }
        
        .rival-selector {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }
        
        .rival-selector select {
            background: rgba(255,255,255,0.1);
            border: 2px solid #007bff;
            color: #fff;
            padding: 0.8rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .rival-selector select option {
            background: #1a1a1a;
            color: #fff;
        }
        
        /* BOTONES */
        .btn-custom {
            background: linear-gradient(90deg, #ffc107, #ff9800);
            border: none;
            color: #000;
            font-weight: 700;
            padding: 0.8rem 2rem;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(255,193,7,0.3);
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255,193,7,0.5);
        }
        
        /* LOADING */
        .loading-spinner {
            text-align: center;
            padding: 3rem;
            font-size: 1.5rem;
        }
        
        .spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #ffc107;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* LTIMO UPDATE */
        .update-info {
            text-align: center;
            color: #aaa;
            font-size: 0.9rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body>

<!-- MODAL DE CONFIGURACIN INICIAL -->
<div class="modal fade" id="modalConfig" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white" style="background: rgba(0,20,50,0.95) !important; border: 2px solid #007bff;">
      <div class="modal-header border-secondary">
        <h5 class="modal-title"><i class="bi bi-gear-fill"></i> Configurar Mi Seguimiento</h5>
      </div>
      <div class="modal-body">
        <div class="mb-4">
          <label class="form-label fw-bold"> C贸digo de Acceso (4 d铆gitos)</label>
          <input type="text" id="codigoAcceso" class="form-control form-control-lg text-center" maxlength="4" placeholder="----" required>
        </div>
        
        <div class="mb-4">
          <label class="form-label fw-bold"> Selecciona Tu Puesto</label>
          <select id="miPuesto" class="form-select form-select-lg">
            <option value="">-- Cargando puestos --</option>
          </select>
        </div>
        
        <div class="mb-4">
          <label class="form-label fw-bold"> Rival 1 (opcional)</label>
          <select id="rival1" class="form-select">
            <option value="">-- No seguir a nadie --</option>
          </select>
        </div>
        
        <div class="mb-4">
          <label class="form-label fw-bold"> Rival 2 (opcional)</label>
          <select id="rival2" class="form-select">
            <option value="">-- No seguir a nadie --</option>
          </select>
        </div>
        
        <button class="btn btn-custom w-100" onclick="guardarConfiguracion()">
          <i class="bi bi-check-circle-fill"></i> Guardar y Comenzar
        </button>
        
        <div id="errorConfig" class="text-danger text-center mt-3" style="min-height: 24px;"></div>
        
        <div class="mt-3 text-center">
          <small class="text-muted">C贸digo por defecto: 1234</small>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CONTENIDO PRINCIPAL -->
<div id="mainContent" style="display: none;">
  <div class="header">
    <h1><i class="bi bi-bullseye"></i> Mi Seguimiento</h1>
    <div id="disciplinaName" class="mt-2" style="font-size: 1.2rem; color: #00d8ff;"></div>
    <div class="status-indicator status-connected" id="statusIndicator">
      <i class="bi bi-wifi"></i> Conectado
    </div>
  </div>
  
  <div class="container-main">
    <div id="loadingArea" class="loading-spinner">
      <div class="spinner"></div>
      <p class="mt-3">Cargando resultados...</p>
    </div>
    
    <div id="contentArea" style="display: none;">
      <!-- MI PUESTO -->
      <div id="miCard" class="card-tirador"></div>
      
      <!-- RIVALES -->
      <div id="rivalesArea">
        <h3 style="color: #00d8ff; margin-bottom: 1rem;">
          <i class="bi bi-eye-fill"></i> Rivales Seguidos
        </h3>
        <div id="rival1Card"></div>
        <div id="rival2Card"></div>
      </div>
      
      <!-- BOTN RECONFIGURAR -->
      <div class="text-center mt-4">
        <button class="btn btn-custom" onclick="reconfigurar()">
          <i class="bi bi-gear-fill"></i> Cambiar Configuraci贸n
        </button>
      </div>
      
      <div class="update-info" id="updateInfo"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const DATOS_COMPETICION_BIN_ID = '68ed56de43b1c97be96636cc';
    const INTERVALO_ACTUALIZACION = 10000; // 10 segundos
    
    let modalConfig;
    let datosCompletos = null;
    let configuracion = {
        miPuesto: null,
        rival1: null,
        rival2: null
    };
    let intervaloActualizacion;
    
    document.addEventListener('DOMContentLoaded', () => {
        modalConfig = new bootstrap.Modal('#modalConfig');
        
        // Verificar si hay configuraci贸n guardada
        const configGuardada = localStorage.getItem('config_tirador');
        if (configGuardada) {
            configuracion = JSON.parse(configGuardada);
            document.getElementById('mainContent').style.display = 'block';
            iniciarSeguimiento();
        } else {
            modalConfig.show();
            cargarPuestosDisponibles();
        }
    });
    
    async function cargarPuestosDisponibles() {
        try {
            const response = await fetch(`https://api.jsonbin.io/v3/b/${DATOS_COMPETICION_BIN_ID}/latest`);
            const data = (await response.json()).record;
            
            // Verificar c贸digo de acceso
            if (typeof data.codigo_acceso === 'undefined') {
                throw new Error('Configuraci贸n incorrecta del servidor');
            }
            
            datosCompletos = data;
            
            if (data.datos && data.datos.length > 0) {
                const selectMiPuesto = document.getElementById('miPuesto');
                const selectRival1 = document.getElementById('rival1');
                const selectRival2 = document.getElementById('rival2');
                
                selectMiPuesto.innerHTML = '<option value="">-- Selecciona tu puesto --</option>';
                selectRival1.innerHTML = '<option value="">-- No seguir a nadie --</option>';
                selectRival2.innerHTML = '<option value="">-- No seguir a nadie --</option>';
                
                data.datos.forEach(tirador => {
                    const option = `<option value="${tirador.puesto}">Puesto ${tirador.puesto}</option>`;
                    selectMiPuesto.innerHTML += option;
                    selectRival1.innerHTML += option;
                    selectRival2.innerHTML += option;
                });
            }
        } catch (error) {
            console.error('Error cargando puestos:', error);
            document.getElementById('errorConfig').textContent = 'Error al cargar datos del servidor';
        }
    }
    
    async function guardarConfiguracion() {
        const codigo = document.getElementById('codigoAcceso').value.trim();
        const miPuesto = document.getElementById('miPuesto').value;
        const rival1 = document.getElementById('rival1').value;
        const rival2 = document.getElementById('rival2').value;
        const errorDiv = document.getElementById('errorConfig');
        
        errorDiv.textContent = '';
        
        if (!codigo || codigo.length !== 4) {
            errorDiv.textContent = 'Introduce un c贸digo de 4 d铆gitos';
            return;
        }
        
        if (!miPuesto) {
            errorDiv.textContent = 'Selecciona tu puesto';
            return;
        }
        
        try {
            // Verificar c贸digo
            const response = await fetch(`https://api.jsonbin.io/v3/b/${DATOS_COMPETICION_BIN_ID}/latest`);
            const data = (await response.json()).record;
            
            if (String(data.codigo_acceso) !== codigo) {
                errorDiv.textContent = 'C贸digo de acceso incorrecto';
                return;
            }
            
            // Guardar configuraci贸n
            configuracion = {
                miPuesto: miPuesto,
                rival1: rival1 || null,
                rival2: rival2 || null
            };
            
            localStorage.setItem('config_tirador', JSON.stringify(configuracion));
            
            modalConfig.hide();
            document.getElementById('mainContent').style.display = 'block';
            iniciarSeguimiento();
            
        } catch (error) {
            console.error('Error:', error);
            errorDiv.textContent = 'Error de conexi贸n';
        }
    }
    
    function iniciarSeguimiento() {
        cargarYMostrarDatos();
        
        if (intervaloActualizacion) {
            clearInterval(intervaloActualizacion);
        }
        intervaloActualizacion = setInterval(cargarYMostrarDatos, INTERVALO_ACTUALIZACION);
    }
    
    async function cargarYMostrarDatos() {
        try {
            const response = await fetch(`https://api.jsonbin.io/v3/b/${DATOS_COMPETICION_BIN_ID}/latest`);
            const data = (await response.json()).record;
            
            document.getElementById('disciplinaName').textContent = data.disciplina || 'Competici贸n';
            document.getElementById('statusIndicator').className = 'status-indicator status-connected';
            document.getElementById('statusIndicator').innerHTML = '<i class="bi bi-wifi"></i> Conectado';
            
            if (data.datos && data.datos.length > 0) {
                mostrarDatos(data.datos);
                document.getElementById('loadingArea').style.display = 'none';
                document.getElementById('contentArea').style.display = 'block';
            }
            
            const ahora = new Date();
            document.getElementById('updateInfo').innerHTML = `
                <i class="bi bi-clock"></i> ltima actualizaci贸n: ${ahora.toLocaleTimeString()}
            `;
            
        } catch (error) {
            console.error('Error cargando datos:', error);
            document.getElementById('statusIndicator').className = 'status-indicator status-disconnected';
            document.getElementById('statusIndicator').innerHTML = '<i class="bi bi-wifi-off"></i> Sin conexi贸n';
        }
    }
    
    function mostrarDatos(datos) {
        const miDatos = datos.find(t => String(t.puesto) === String(configuracion.miPuesto));
        const rival1Datos = configuracion.rival1 ? datos.find(t => String(t.puesto) === String(configuracion.rival1)) : null;
        const rival2Datos = configuracion.rival2 ? datos.find(t => String(t.puesto) === String(configuracion.rival2)) : null;
        
        // Calcular posici贸n en la clasificaci贸n
        const clasificacion = [...datos].sort((a, b) => (b.total || 0) - (a.total || 0));
        const miPosicion = clasificacion.findIndex(t => String(t.puesto) === String(configuracion.miPuesto)) + 1;
        
        // Mostrar mi card
        if (miDatos) {
            document.getElementById('miCard').innerHTML = crearCardPrincipal(miDatos, miPosicion);
        }
        
        // Mostrar rivales
        if (rival1Datos) {
            const posRival1 = clasificacion.findIndex(t => String(t.puesto) === String(configuracion.rival1)) + 1;
            document.getElementById('rival1Card').innerHTML = crearCardRival(rival1Datos, posRival1, 1);
        } else {
            document.getElementById('rival1Card').innerHTML = '';
        }
        
        if (rival2Datos) {
            const posRival2 = clasificacion.findIndex(t => String(t.puesto) === String(configuracion.rival2)) + 1;
            document.getElementById('rival2Card').innerHTML = crearCardRival(rival2Datos, posRival2, 2);
        } else {
            document.getElementById('rival2Card').innerHTML = '';
        }
    }
    
    function crearCardPrincipal(datos, posicion) {
        const series = datos.series || datos.parciales || [];
        
        return `
            <div class="text-center">
                <div class="puesto-badge">${posicion}潞</div>
                <div class="nombre-tirador">Puesto ${datos.puesto}</div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Total</div>
                    <div class="stat-value stat-total">${datos.total || 0}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">X</div>
                    <div class="stat-value stat-x">${datos.xTotal || 0}</div>
                </div>
            </div>
            
            ${series.length > 0 ? `
                <div class="series-container">
                    ${series.map((s, i) => `
                        <div class="serie-badge">S${i+1}: ${s !== null ? s : '-'}</div>
                    `).join('')}
                </div>
            ` : ''}
        `;
    }
    
    function crearCardRival(datos, posicion, numeroRival) {
        const series = datos.series || datos.parciales || [];
        const diferencia = datos.total - (document.getElementById('miCard').querySelector('.stat-total') ? 
            parseInt(document.getElementById('miCard').querySelector('.stat-total').textContent) : 0);
        const textodiferencia = diferencia > 0 ? `+${diferencia}` : diferencia;
        
        return `
            <div class="card-rival">
                <div class="rival-header">
                    <div>
                        <div class="nombre-rival">Rival ${numeroRival} - Puesto ${datos.puesto}</div>
                        <small style="color: #aaa;">${posicion}潞 en clasificaci贸n</small>
                    </div>
                    <div class="puesto-small">${posicion}潞</div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Total</div>
                        <div class="stat-value">${datos.total || 0}</div>
                        <small style="color: ${diferencia >= 0 ? '#ff4d6d' : '#00ff9c'};">${textodiferencia}</small>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">X</div>
                        <div class="stat-value">${datos.xTotal || 0}</div>
                    </div>
                </div>
                
                ${series.length > 0 ? `
                    <div class="series-container">
                        ${series.map((s, i) => `
                            <div class="serie-badge" style="font-size: 0.9rem;">S${i+1}: ${s !== null ? s : '-'}</div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    function reconfigurar() {
        localStorage.removeItem('config_tirador');
        location.reload();
    }
    
    window.addEventListener('beforeunload', () => {
        if (intervaloActualizacion) {
            clearInterval(intervaloActualizacion);
        }
    });
</script>

</body>
</html>
