<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="15">
    <title>Resultados en Vivo - Tiro Deportivo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #000;
            color: #fff;
            padding: 20px;
            overflow: hidden;
        }
        .container-fluid {
            padding-left: 30px;
            padding-right: 30px;
        }
        .titulo-principal {
            font-size: 3.5rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            color: #ffc107;
        }
        .table {
            border-color: #444;
        }
        .table th, .table td {
            font-size: 2.2rem;
            text-align: center;
            vertical-align: middle;
            padding: 15px;
            border-color: #444;
        }
        .table thead th {
            background-color: #0d6efd;
            color: #fff;
            border-color: #000;
        }
        tbody tr:nth-child(odd) {
            background-color: #212529;
        }
        tbody tr:nth-child(even) {
            background-color: #343a40;
        }
        .total-cell {
            background-color: #ffc107 !important;
            color: #000 !important;
            font-weight: bold;
            font-size: 2.5rem;
        }
        #info-actualizacion {
            text-align: center;
            margin-top: 15px;
            font-size: 1rem;
            color: #888;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <h1 class="titulo-principal" id="tituloPrincipal">游꿢 Resultados en Vivo 游꿢</h1>
    <div id="tabla-resultados-container">
        <p style="font-size: 1.5rem; text-align: center;">Cargando resultados...</p>
    </div>
    <p id="info-actualizacion">Actualizado a las: <span id="hora-actualizacion">--:--:--</span></p>
</div>

<script>
    // Funci칩n para obtener par치metros de la URL
    function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        const dataParam = params.get('data');
        
        if (dataParam) {
            try {
                return JSON.parse(decodeURIComponent(dataParam));
            } catch (error) {
                console.error('Error parsing URL data:', error);
                return null;
            }
        }
        return null;
    }

    // Funci칩n para mostrar datos desde URL
    function mostrarDatosDesdeURL(datos) {
        const container = document.getElementById('tabla-resultados-container');
        
        let tablaHTML = `<table class="table table-bordered table-dark">
                            <thead>
                                <tr>
                                    <th>Pos</th>
                                    <th>Puesto</th>`;

        // Crear encabezados din치micos seg칰n el tipo de datos
        if (datos.tipo === 'resultados_parciales') {
            for (let i = 1; i <= 6; i++) {
                tablaHTML += `<th>S${i}</th>`;
            }
        } else {
            for (let i = 1; i <= 12; i++) {
                tablaHTML += `<th>S${i}</th>`;
            }
        }

        tablaHTML += `           <th>Total</th>
                                    <th>X</th>
                                </tr>
                            </thead>
                            <tbody>`;

        // Ordenar por total (mayor a menor)
        const datosOrdenados = [...datos.datos].sort((a, b) => b.total - a.total);

        datosOrdenados.forEach((competidor, index) => {
            tablaHTML += `<tr>
                            <td>${index + 1}</td>
                            <td>${competidor.puesto}</td>`;

            // Mostrar series seg칰n el tipo
            if (datos.tipo === 'resultados_parciales') {
                competidor.parciales.forEach(score => {
                    tablaHTML += `<td>${score || 0}</td>`;
                });
            } else {
                competidor.series.forEach(score => {
                    tablaHTML += `<td>${score || 0}</td>`;
                });
            }

            tablaHTML += `       <td class="total-cell">${competidor.total}</td>
                                <td>${competidor.xTotal || 0}</td>
                          </tr>`;
        });

        tablaHTML += `</tbody></table>`;
        container.innerHTML = tablaHTML;
        
        // Actualizar t칤tulo
        document.getElementById('tituloPrincipal').textContent = datos.titulo || '游꿢 Resultados en Vivo 游꿢';
        
        const ahora = new Date();
        document.getElementById('hora-actualizacion').textContent = ahora.toLocaleTimeString();
    }

    // Funci칩n para cargar desde localStorage (compatibilidad con app)
    function cargarResultadosLocalStorage() {
        const datosGuardados = localStorage.getItem('puntuacionesPistolaLibre');

        if (datosGuardados) {
            const datos = JSON.parse(datosGuardados);
            const tiradores = datos.tiradores || {};
            const container = document.getElementById('tabla-resultados-container');

            let tablaHTML = `<table class="table table-bordered table-dark">
                                <thead>
                                    <tr>
                                        <th>Puesto</th>
                                        <th>Tirador</th>
                                        <th>S1</th><th>S2</th><th>S3</th><th>S4</th><th>S5</th><th>S6</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>`;

            const tiradoresOrdenados = Object.values(tiradores).sort((a, b) => b.total - a.total);

            tiradoresOrdenados.forEach((tirador, index) => {
                tablaHTML += `<tr>
                                <td>${index + 1}</td>
                                <td>${tirador.nombre}</td>
                                ${[1, 2, 3, 4, 5, 6].map(i => `<td>${tirador.series[i]?.total || 0}</td>`).join('')}
                                <td class="total-cell">${tirador.total}</td>
                              </tr>`;
            });

            tablaHTML += `</tbody></table>`;
            container.innerHTML = tablaHTML;
        } else {
             document.querySelector('#tabla-resultados-container p').textContent = 'A칰n no hay resultados guardados.';
        }

        const ahora = new Date();
        document.getElementById('hora-actualizacion').textContent = ahora.toLocaleTimeString();
    }

    // Funci칩n principal que decide de d칩nde cargar los datos
    function cargarResultados() {
        // PRIMERO intentar cargar de URL
        const urlData = getUrlParams();
        if (urlData) {
            mostrarDatosDesdeURL(urlData);
            return;
        }
        
        // SI NO, cargar de localStorage (compatibilidad con app)
        cargarResultadosLocalStorage();
    }

    document.addEventListener('DOMContentLoaded', function () {
        cargarResultados();
    });
</script>
</body>
</html>