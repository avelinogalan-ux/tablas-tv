<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV - Resultados Tiro Deportivo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d3436 100%);
            color: white;
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container-tv {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header-tv {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            border: 2px solid rgba(255,255,255,0.2);
        }
        .tabla-resultados-tv {
            width: 100%;
            border-collapse: collapse;
            background: white;
            color: black;
            font-size: 1.1em;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border-radius: 10px;
            overflow: hidden;
        }
        .tabla-resultados-tv th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 15px 10px;
            font-weight: 600;
            text-align: center;
            border: none;
        }
        .tabla-resultados-tv td {
            padding: 12px 8px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        .esperando-datos {
            text-align: center;
            font-size: 1.5em;
            margin-top: 50px;
            color: #bdc3c7;
        }
        .puesto-destacado {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%) !important;
            font-weight: bold;
        }
        .total-destacado {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%) !important;
            color: white !important;
            font-weight: bold;
        }
        .x-destacado {
            background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%) !important;
            color: white !important;
            font-weight: bold;
        }
        .status-connected {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
            color: #2ecc71;
        }
        .status-waiting {
            background: rgba(241, 196, 15, 0.2);
            border: 1px solid #f1c40f;
            color: #f1c40f;
        }
    </style>
</head>
<body>
    <div class="container-tv">
        <div class="header-tv">
            <h1 class="display-4 mb-3">üéØ SISTEMA DE COMPETICI√ìN</h1>
            <h2 class="mb-4">Pistola 9mm / Fuego Central</h2>
            
            <div id="infoActualizacion" class="status-waiting p-3 rounded">
                <div class="d-flex align-items-center justify-content-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    <span>üîÑ Esperando datos del sistema...</span>
                </div>
            </div>
        </div>

        <div id="contenido">
            <div class="esperando-datos" id="esperando">
                <div class="mb-3">
                    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
                </div>
                <h4>Listo para recibir resultados</h4>
                <p class="text-muted">Los datos aparecer√°n autom√°ticamente cuando el sistema los env√≠e</p>
                <div class="mt-4">
                    <small class="text-info">üí° Usa el c√≥digo QR en el sistema principal para enviar datos</small>
                </div>
            </div>
            <div id="tablasContainer" style="display: none;"></div>
        </div>
    </div>

   / =========================================================================
// L√ìGICA DE TV - VERSI√ìN CANAL UNIVERSAL (DEFINITIVA)
// =========================================================================

// ‚ñº‚ñº‚ñº PEGA AQU√ç EL MISMO ID DE CANAL UNIVERSAL ‚ñº‚ñº‚ñº
const CANAL_UNIVERSAL_ID = '68e187bdd0ea881f40956915';
// ‚ñ≤‚ñ≤‚ñ≤ PEGA AQU√ç EL MISMO ID DE CANAL UNIVERSAL ‚ñ≤‚ñ≤‚ñ≤

let ultimoContenido = ''; // Variable para evitar parpadeos si los datos no cambian

async function consultarCanal() {
    if (CANAL_UNIVERSAL_ID === 'PEGA_AQUI_EL_ID_QUE_COPIASTE') { // Doble chequeo por si acaso
        document.getElementById('esperando').innerHTML = `<h4>Error de Configuraci√≥n</h4><p>El ID del canal no ha sido configurado en la p√°gina de TV.</p>`;
        return;
    }

    const infoElement = document.getElementById('infoActualizacion');

    try {
        const respuesta = await fetch(`https://api.jsonbin.io/v3/b/${CANAL_UNIVERSAL_ID}/latest`);

        if (!respuesta.ok) {
            throw new Error(`Error ${respuesta.status} al contactar con el canal.`);
        }

        const contenidoTexto = await respuesta.text();

        // Si el contenido no ha cambiado, no hacemos nada para evitar refrescar la pantalla innecesariamente.
        if (contenidoTexto === ultimoContenido) {
            return;
        }

        ultimoContenido = contenidoTexto;
        // La respuesta de 'latest' envuelve los datos en un objeto 'record'.
        const datos = JSON.parse(contenidoTexto).record;

        // Si el bin est√° vac√≠o o es la primera vez, 'datos' podr√≠a no existir.
        if (!datos || !datos.tipo) {
            console.log("Canal vac√≠o o esperando primer env√≠o de datos...");
            return;
        }

        // Llamamos a la funci√≥n principal que dibuja las tablas.
        mostrarResultadosTV(datos);

        document.getElementById('esperando').style.display = 'none';
        document.getElementById('tablasContainer').style.display = 'block';

        const ahora = new Date();
        infoElement.className = 'status-connected p-3 rounded';
        infoElement.innerHTML = `
            <div class="text-center">
                <span class="fw-bold">‚úÖ EN DIRECTO</span><br>
                <small>√öltima Actualizaci√≥n: ${ahora.toLocaleTimeString()} | ${datos.disciplina.toUpperCase()}</small>
            </div>
        `;

    } catch (error) {
        console.error("‚ùå Error al buscar datos en el canal:", error);
        infoElement.className = 'status-disconnected p-3 rounded';
        infoElement.innerHTML = `<div class="text-center">‚ùå Error al recibir datos. Verificando de nuevo...</div>`;
    }
}

// Al cargar la p√°gina, consulta el canal inmediatamente y luego repite cada 10 segundos.
document.addEventListener('DOMContentLoaded', function() {
    console.log("‚úÖ Sistema de TV por Canal Universal iniciado.");
    consultarCanal(); // Primera llamada inmediata
    setInterval(consultarCanal, 10000); // Llamadas peri√≥dicas cada 10 segundos
});


// =========================================================================
// LAS SIGUIENTES FUNCIONES (QUE YA TIENES) NO CAMBIAN.
// SOLO ASEG√öRATE DE QUE EST√âN PRESENTES DEBAJO DE ESTA L√çNEA.
// =========================================================================

function mostrarResultadosTV(datos) {
    const container = document.getElementById('tablasContainer');
    container.innerHTML = ''; // Limpiar contenido anterior

    if (datos.tipo === 'finales') {
        crearTablaFinales(datos.datos, container, datos.disciplina);
    } else if (datos.tipo === 'parciales') {
        crearTablaParciales(datos.datos, container, datos.disciplina);
    }
}

function crearTablaFinales(resultados, container, disciplina) {
    let tablaHTML = `
        <h1 class="text-center mb-4">${disciplina} - Clasificaci√≥n Final</h1>
        <table class="table table-dark table-striped table-bordered table-hover">
            <thead class="table-primary">
                <tr>
                    <th>Pos.</th><th>Puesto</th><th>S1</th><th>S2</th><th>S3</th><th>S4</th><th>S5</th><th>S6</th>
                    <th class="table-warning">S7</th><th class="table-warning">S8</th><th class="table-warning">S9</th><th class="table-warning">S10</th><th class="table-warning">S11</th><th class="table-warning">S12</th>
                    <th class="table-success">Total</th><th class="table-info">X</th>
                </tr>
            </thead>
            <tbody>
    `;

    resultados.forEach((r, index) => {
        tablaHTML += `
            <tr>
                <td class="fw-bold">${index + 1}¬∫</td>
                <td>Puesto ${r.puesto}</td>
                ${r.series.map((s, i) => `<td class="${i < 6 ? '' : 'table-light-warning'}">${s}</td>`).join('')}
                <td class="table-success fw-bold">${r.total}</td>
                <td class="table-info fw-bold">${r.xTotal}</td>
            </tr>
        `;
    });

    tablaHTML += '</tbody></table>';
    container.innerHTML = tablaHTML;
}

function crearTablaParciales(resultados, container, disciplina) {
    let tablaHTML = `
        <h1 class="text-center mb-4">${disciplina} - Clasificaci√≥n Parcial</h1>
        <table class="table table-dark table-striped table-bordered table-hover">
            <thead class="table-primary">
                <tr>
                    <th>Pos.</th><th>Puesto</th><th>Prec. 1</th><th>Prec. 2</th><th>Prec. 3</th>
                    <th class="table-warning">Duelo 1</th><th class="table-warning">Duelo 2</th><th class="table-warning">Duelo 3</th>
                    <th class="table-success">Total</th><th class="table-info">X</th>
                </tr>
            </thead>
            <tbody>
    `;

    resultados.forEach((r, index) => {
        tablaHTML += `
            <tr>
                <td class="fw-bold">${index + 1}¬∫</td>
                <td>Puesto ${r.puesto}</td>
                ${r.parciales.map((p, i) => `<td class="${i < 3 ? '' : 'table-light-warning'}">${p}</td>`).join('')}
                <td class="table-success fw-bold">${r.total}</td>
                <td class="table-info fw-bold">${r.xTotal}</td>
            </tr>
        `;
    });

    tablaHTML += '</tbody></table>';
    container.innerHTML = tablaHTML;
}
</body>
</html>
</script>


