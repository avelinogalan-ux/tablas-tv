<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV - Conexión a Resultados</title>
    <!-- Tus Links y CSS (sin cambios) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        /* Tu CSS aquí (sin cambios) */
        body { background: radial-gradient(circle at center, #000428 0%, #004e92 100%); color: #fff; font-family: 'Rajdhani', sans-serif; margin:0; padding:0; overflow:hidden; }
        .container-tv { width:100%; height:100vh; display:flex; flex-direction:column; justify-content:flex-start; }
        header { position:relative; background:linear-gradient(90deg,#002bff 0%,#001242 100%); padding:1.5vh 3vw; border-bottom:0.5vh solid #ffc107; display:flex; align-items:center; justify-content:center; }
        .logo-izquierdo { position:absolute; left:3vw; height:clamp(60px,10vh,130px); filter:drop-shadow(0 0 10px rgba(255,255,255,0.7)); }
        h1.display-5 { font-size:clamp(2rem,4vw,4.5rem); text-transform:uppercase; text-shadow:0 0 25px rgba(255,255,255,0.9); margin:0; }
        .logo-trasona { display:block; margin:5vh auto 4vh; height:clamp(180px,35vh,380px); width:auto; filter:drop-shadow(0 0 30px rgba(255,255,255,0.8)); animation:aparecerLogo 1.5s ease-out; }
        @keyframes aparecerLogo { from {opacity:0; transform:scale(0.8);} to {opacity:1; transform:scale(1);} }
        .status-box { max-width:60vw; margin:1vh auto 0; padding:0.7rem; border-radius:0.5rem; font-size:clamp(1rem,1.6vw,1.7rem); font-weight:bold; text-align:center; }
        .status-connected { background: rgba(0,255,136,0.2); border:2px solid #00ff88; color:#00ff88; text-shadow:0 0 15px rgba(0,255,136,0.7); }
        .status-disconnected { background: rgba(255,0,60,0.2); border:2px solid #ff003c; color:#ff4d6d; }
        .table-container { flex-grow:1; overflow-y:auto; scroll-behavior:smooth; margin:2vh auto; width:95%; }
        .table { font-size:clamp(1rem,2vw,2.5rem); border-color:#00bfff; color:#fff; background:rgba(0,60,150,0.3); backdrop-filter:blur(8px); min-width:1500px; }
        .table thead { background: linear-gradient(90deg,#001f7a 0%,#0048ff 100%); color:#fff; text-transform:uppercase; border-bottom:0.5vh solid #ffc107; position:sticky; top:0; z-index:10; font-size:clamp(1rem,1.6vw,2rem); }
        .table th,.table td { text-align:center; vertical-align:middle; padding:1.2rem; }
        .table-success { background-color:rgba(0,255,136,0.25)!important; color:#00ff9c; font-weight:700; }
        .table-info { background-color:rgba(0,229,255,0.25)!important; color:#00d8ff; font-weight:700; }
        tr:hover { background-color:rgba(255,255,255,0.08); }
        .resultados-header { position:sticky; top:0; background:radial-gradient(circle at top, rgba(0,10,60,0.95), rgba(0,10,30,0.9)); padding:1vh 0; text-align:center; font-size:clamp(1.6rem,3vw,3rem); color:#ffc107; text-transform:uppercase; font-weight:700; z-index:20; box-shadow:0 6px 12px rgba(0,0,0,0.5); }
        .contador-actualizacion { font-size:clamp(1rem,1.5vw,1.6rem); color:#00e6ff; text-shadow:0 0 8px rgba(0,230,255,0.9); margin-top:0.5vh; }
    </style>
</head>
<body>

<!-- MODAL DE ACCESO (sin cambios) -->
<div class="modal fade" id="modalAcceso" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white" style="backdrop-filter: blur(10px); background: rgba(0,20,50,0.7) !important;">
      <div class="modal-header border-secondary">
        <h5 class="modal-title">Conexión a Resultados en Directo</h5>
      </div>
      <div class="modal-body text-center">
        <p>Introduce el código de acceso de 4 dígitos.</p>
        <form id="formAcceso">
          <input type="text" id="accessCodeInput" class="form-control form-control-lg text-center my-3" maxlength="4" placeholder="----" required>
          <button type="submit" class="btn btn-primary btn-lg w-100">
            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
            Conectar
          </button>
          <div id="errorMessage" class="text-danger mt-3" style="height:24px;"></div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Contenido principal (sin cambios) -->
<div id="mainContent" class="container-tv" style="display: none; flex-direction: column;">
  <header>
    <img src="shooting_logo.png" alt="Logo Izquierdo" class="logo-izquierdo">
    <div class="text-center">
      <h1 class="display-5 fw-bold">Resultados en Directo</h1>
      <div id="infoActualizacion" class="status-box rounded mx-auto" style="display:none;"></div>
    </div>
  </header>
  <div id="logoCentral">
    <img src="trasona-logo.png" alt="Club de Tiro Ensidesa Trasona" class="logo-trasona">
  </div>
  <main id="contenido">
    <div class="table-container" id="tablasContainer" style="display:none;"></div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ===================================================================================
    // --- CONFIGURACIÓN SIMPLIFICADA ---
    // ===================================================================================
    const DATOS_BIN_ID ='68ed56de43b1c97be96636cc'; 
    // ¡NO SE NECESITAN CLAVES AQUÍ!
    // ===================================================================================

    const INTERVALO_ACTUALIZACION = 30000;
    let ultimoContenido = '';
    let datosCargados; // Variable para guardar los datos temporalmente

    // --- ELEMENTOS DEL DOM (sin cambios) ---
    const modalAcceso = new bootstrap.Modal('#modalAcceso');
    const formAcceso = document.getElementById('formAcceso');
    const accessCodeInput = document.getElementById('accessCodeInput');
    const errorMessage = document.getElementById('errorMessage');
    const spinner = formAcceso.querySelector('.spinner-border');
    const mainContent = document.getElementById('mainContent');
    const infoElement = document.getElementById('infoActualizacion');
    const logoCentral = document.getElementById('logoCentral');
    const tablasContainer = document.getElementById('tablasContainer');

    // --- LÓGICA DE INICIO (sin cambios) ---
    document.addEventListener('DOMContentLoaded', () => {
        if (sessionStorage.getItem('acceso_concedido_tv') === 'true') {
            mainContent.style.display = 'flex';
            iniciarCargaDeResultados();
        } else {
            modalAcceso.show();
        }
    });

    // --- LÓGICA DE ACCESO (MODIFICADA) ---
    formAcceso.addEventListener('submit', async (e) => {
        e.preventDefault();
        const codigoIntroducido = accessCodeInput.value.trim();
        spinner.classList.remove('d-none');
        formAcceso.querySelector('button').disabled = true;
        errorMessage.textContent = '';

        try {
            // Petición al ÚNICO BIN PÚBLICO
            const response = await fetch(`https://api.jsonbin.io/v3/b/${DATOS_BIN_ID}/latest`);
            if (!response.ok) throw new Error('No se pudo contactar con el servidor de resultados.');
            
            datosCargados = (await response.json()).record;
            const codigoCorrecto = datosCargados.codigo_acceso;

            if (codigoIntroducido === codigoCorrecto) {
                sessionStorage.setItem('acceso_concedido_tv', 'true');
                modalAcceso.hide();
                mainContent.style.display = 'flex';
                // Usamos los datos que ya hemos cargado para la primera visualización
                mostrarResultados(datosCargados); 
                // Iniciamos las actualizaciones periódicas
                setInterval(consultarResultados, INTERVALO_ACTUALIZACION);
            } else {
                throw new Error('Código de acceso incorrecto.');
            }
        } catch (error) {
            errorMessage.textContent = error.message;
        } finally {
            spinner.classList.add('d-none');
            formAcceso.querySelector('button').disabled = false;
        }
    });
    
    // --- LÓGICA DE CARGA PERIÓDICA (MODIFICADA) ---
    function iniciarCargaDeResultados() {
        consultarResultados(); // Carga inicial
        setInterval(consultarResultados, INTERVALO_ACTUALIZACION);
    }

    async function consultarResultados() {
      try {
        const respuesta = await fetch(`https://api.jsonbin.io/v3/b/${DATOS_BIN_ID}/latest`);
        if (!respuesta.ok) throw new Error(`Error de red: ${respuesta.status}`);
        
        const contenidoTexto = await respuesta.text();
        if (contenidoTexto === ultimoContenido) return;
        ultimoContenido = contenidoTexto;

        const datos = JSON.parse(contenidoTexto).record;
        mostrarResultados(datos);
      } catch (error) {
        infoElement.style.display = 'block';
        infoElement.className = 'status-box status-disconnected';
        infoElement.innerHTML = `<div class="text-center">❌ ${error.message}</div>`;
      }
    }

    // --- FUNCIÓN PARA MOSTRAR LOS DATOS (MODIFICADA) ---
    function mostrarResultados(datos) {
        if (!datos || !datos.datos) {
            infoElement.style.display = 'block';
            infoElement.className = 'status-box status-disconnected';
            infoElement.innerHTML = `<div class="text-center">❌ Formato de datos incorrecto.</div>`;
            return;
        }
        logoCentral.style.display = 'none';
        tablasContainer.style.display = 'block';
        infoElement.style.display = 'block';
        mostrarTablaUnificada(datos);
        infoElement.className = 'status-box status-connected';
        infoElement.innerHTML = `
          <div class="text-center">
            <span class="fw-bold"><i class="bi bi-check-circle-fill"></i> EN DIRECTO</span><br>
            <small>${datos.disciplina.toUpperCase()}</small>
            <div class="contador-actualizacion">Actualizado: ${new Date().toLocaleTimeString()}</div>
          </div>`;
    }

    // --- FUNCIÓN PARA DIBUJAR LA TABLA (sin cambios) ---
    function mostrarTablaUnificada(datos) {
        const resultados = datos.datos || [];
        const container = document.getElementById('tablasContainer');
        if (!resultados.length) {
            container.innerHTML = `<h2 class="text-center text-warning mt-5">Sin datos disponibles</h2>`;
            return;
        }
        const numSeries = resultados[0].series ? resultados[0].series.length : (resultados[0].parciales?.length || 0);
        let tablaHTML = `<div class="resultados-header">${datos.disciplina}</div><div class="scroll-animado table-wrapper"><table class="table table-dark table-bordered table-hover"><thead><tr><th>Pos.</th><th>Puesto</th><th>Nombre</th>${Array.from({ length: numSeries }, (_, i) => `<th>S${i+1}</th>`).join('')}<th>Total</th><th>X</th></tr></thead><tbody>`;
        resultados.sort((a,b) => parseFloat(b.total)-parseFloat(a.total) || parseFloat(b.xTotal)-parseFloat(a.xTotal));
        resultados.forEach((r,index) => {
            const series = r.series || r.parciales || [];
            tablaHTML += `<tr><td class="fw-bold text-warning">${index+1}º</td><td>Puesto ${r.puesto || '-'}</td><td>${r.nombre || 'Anónimo'}</td>${series.map(s => `<td>${s !== null ? s : '-'}</td>`).join('')}<td class="table-success fw-bold">${r.total}</td><td class="table-info fw-bold">${r.xTotal}</td></tr>`;
        });
        tablaHTML += '</tbody></table></div>';
        container.innerHTML = tablaHTML;
    }
</script>
</body>
</html>


