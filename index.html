<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- CONFIGURACIÓN ---    const DATOS_COMPETICION_BIN_ID = '68ed56de43b1c97be96636cc'; // Tu ID de Bin público
    const INTERVALO_ACTUALIZACION = 15000; // 15 segundos
    let ultimoContenido = '';

    // --- ELEMENTOS DEL DOM ---
    const modalAcceso = new bootstrap.Modal('#modalAcceso');
    const formAcceso = document.getElementById('formAcceso');
    const accessCodeInput = document.getElementById('accessCodeInput');
    const errorMessage = document.getElementById('errorMessage');
    const spinner = formAcceso.querySelector('.spinner-border');
    const mainContent = document.getElementById('mainContent');
    const infoElement = document.getElementById('infoActualizacion');
    const logoCentral = document.getElementById('logoCentral');
    const tablasContainer = document.getElementById('tablasContainer');

    // --- LÓGICA DE INICIO ---
    document.addEventListener('DOMContentLoaded', () => {
        if (sessionStorage.getItem('acceso_concedido_tv') === 'true') {
            mainContent.style.display = 'flex';
            iniciarCargaDeResultados();
        } else {
            modalAcceso.show();
        }
    });

    // --- LÓGICA DE ACCESO (SOLO SE EJECUTA UNA VEZ) ---
    formAcceso.addEventListener('submit', async (e) => {
        e.preventDefault();
        const codigoIntroducido = accessCodeInput.value.trim();
        spinner.classList.remove('d-none');
        formAcceso.querySelector('button').disabled = true;
        errorMessage.textContent = '';

        try {
            const response = await fetch(`https://api.jsonbin.io/v3/b/${DATOS_COMPETICION_BIN_ID}/latest`);
            if (!response.ok) throw new Error(`404: No se encontró el Bin. Verifica el ID.`);
            
            const data = (await response.json()).record;
            
            // La primera vez, el Bin DEBE tener el campo "codigo_acceso"
            if (typeof data.codigo_acceso === 'undefined') {
                 throw new Error('El formato inicial del Bin es incorrecto. Falta "codigo_acceso".');
            }
            const codigoCorrecto = String(data.codigo_acceso);

            if (codigoIntroducido === codigoCorrecto) {
                sessionStorage.setItem('acceso_concedido_tv', 'true');
                modalAcceso.hide();
                mainContent.style.display = 'flex';
                // Mostramos los datos y empezamos a actualizar
                mostrarResultados(data); 
                iniciarCargaDeResultados();
            } else {
                throw new Error('Código de acceso incorrecto.');
            }
        } catch (error) {
            errorMessage.textContent = error.message;
        } finally {
            spinner.classList.add('d-none');
            formAcceso.querySelector('button').disabled = false;
        }
    });
    
    // --- LÓGICA DE CARGA PERIÓDICA ---
    function iniciarCargaDeResultados() {
        consultarResultados(); // Carga inicial
        setInterval(consultarResultados, INTERVALO_ACTUALIZACION);
    }

    async function consultarResultados() {
      try {
        const respuesta = await fetch(`https://api.jsonbin.io/v3/b/${DATOS_COMPETICION_BIN_ID}/latest`);
        if (!respuesta.ok) throw new Error(`Error de red: ${respuesta.status}`);
        
        const contenidoTexto = await respuesta.text();
        if (contenidoTexto === ultimoContenido) return;
        ultimoContenido = contenidoTexto;

        const datos = JSON.parse(contenidoTexto).record;
        // La función que muestra los resultados se encarga de todo
        mostrarResultados(datos);
      } catch (error) {
        // Gestionar el error de forma silenciosa o mostrar un pequeño indicador
        console.error("Error en actualización periódica:", error.message);
        infoElement.className = 'status-box status-disconnected';
        infoElement.innerHTML = `<div class="text-center">⚠️ ${error.message}</div>`;
      }
    }

    // --- FUNCIÓN INTELIGENTE PARA PROCESAR Y MOSTRAR DATOS ---
    function mostrarResultados(datos) {
        // ¡CAMBIO CLAVE! Esta función ya no exige "codigo_acceso"
        if (!datos || !datos.datos) {
            infoElement.style.display = 'block';
            infoElement.className = 'status-box status-disconnected';
            infoElement.innerHTML = `<div class="text-center">❌ Formato de datos incorrecto o Bin vacío.</div>`;
            return;
        }
        
        // "Traduce" los datos que llegan, añadiendo el nombre si falta.
        const datosTraducidos = datos.datos.map(tirador => ({
            ...tirador,
            nombre: tirador.nombre || `Tirador ${tirador.puesto}`
        }));

        const datosParaTabla = {
            disciplina: datos.disciplina || 'Resultados en Directo',
            datos: datosTraducidos
        };

        // Muestra los datos en pantalla
        logoCentral.style.display = 'none';
        tablasContainer.style.display = 'block';
        infoElement.style.display = 'block';
        mostrarTablaUnificada(datosParaTabla); 
        
        // Actualiza el estado de la conexión
        infoElement.className = 'status-box status-connected';
        infoElement.innerHTML = `
          <div class="text-center">
            <span class="fw-bold"><i class="bi bi-check-circle-fill"></i> EN DIRECTO</span><br>
            <small>${(datos.disciplina || '').toUpperCase()}</small>
            <div class="contador-actualizacion">Actualizado: ${new Date().toLocaleTimeString()}</div>
          </div>`;
    }

    // --- FUNCIÓN PARA DIBUJAR LA TABLA (SIN CAMBIOS) ---
    function mostrarTablaUnificada(datos) {
        const resultados = datos.datos || [];
        const container = document.getElementById('tablasContainer');
        if (!resultados.length) {
            container.innerHTML = `<h2 class="text-center text-warning mt-5">Esperando resultados...</h2>`;
            return;
        }
        // Lógica para crear el HTML de la tabla...
        const numSeries = resultados[0].series ? resultados[0].series.length : (resultados[0].parciales?.length || 0);
        let tablaHTML = `<div class="resultados-header">${datos.disciplina}</div><div class="scroll-animado table-wrapper"><table class="table table-dark table-bordered table-hover"><thead><tr><th>Pos.</th><th>Puesto</th><th>Nombre</th>${Array.from({ length: numSeries }, (_, i) => `<th>S${i+1}</th>`).join('')}<th>Total</th><th>X</th></tr></thead><tbody>`;
        resultados.sort((a,b) => parseFloat(b.total)-parseFloat(a.total) || parseFloat(b.xTotal)-parseFloat(a.xTotal));
        resultados.forEach((r,index) => {
            const series = r.series || r.parciales || [];
            tablaHTML += `<tr><td class="fw-bold text-warning">${index+1}º</td><td>Puesto ${r.puesto || '-'}</td><td>${r.nombre || 'Anónimo'}</td>${series.map(s => `<td>${s !== null ? s : '-'}</td>`).join('')}<td class="table-success fw-bold">${r.total}</td><td class="table-info fw-bold">${r.xTotal}</td></tr>`;
        });
        tablaHTML += '</tbody></table></div>';
        container.innerHTML = tablaHTML;
    }
</script>
