<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>TV - Resultados Tiro Deportivo</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">

    <style>
        /* Estilos de tu página de TV (son excelentes, los mantenemos) */
        body {
            background: radial-gradient(circle at center, #000428 0%, #004e92 100%);
            color: #ffffff;
            font-family: 'Rajdhani', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        .container-tv {
            width: 100%;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        header {
            position: relative;
            background: linear-gradient(90deg, #002bff 0%, #001242 100%);
            color: white;
            padding: 2vh 5vw;
            border-bottom: 0.5vh solid #ffc107;
            box-shadow: 0 8px 40px rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .logo-izquierdo {
            position: absolute;
            left: 3vw;
            height: clamp(60px, 10vh, 130px);
            width: auto;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.7));
        }
        h1.display-5 {
            font-size: clamp(2rem, 4vw, 4.5rem);
            text-transform: uppercase;
            letter-spacing: 0.2vw;
            text-shadow: 0 0 25px rgba(255,255,255,0.9);
            margin: 0;
            text-align: center;
        }
        .logo-trasona {
            display: block;
            margin: 5vh auto 4vh;
            height: clamp(180px, 35vh, 380px);
            width: auto;
            filter: drop-shadow(0 0 30px rgba(255,255,255,0.8));
            transition: transform 0.3s ease;
            animation: aparecerLogo 1.5s ease-out;
        }
        .status-connected {
            background: rgba(0,255,136,0.2); border: 2px solid #00ff88; color: #00ff88;
            font-weight: bold; text-shadow: 0 0 15px rgba(0,255,136,0.7);
        }
        .status-disconnected {
            background: rgba(255,0,60,0.2); border: 2px solid #ff003c; color: #ff4d6d;
        }
        .status-waiting {
            background: rgba(255,255,0,0.2); border: 2px solid #ffe600; color: #ffe600;
        }
        .table-container {
            flex-grow: 1;
            overflow-y: auto;
            margin: 2vh auto;
            width: 95%;
        }
        .table {
            font-size: clamp(1rem, 2vw, 2.5rem);
            border-color: #00bfff;
            color: #ffffff;
            background: rgba(0, 60, 150, 0.3);
            backdrop-filter: blur(8px);
        }
        .table thead {
            background: linear-gradient(90deg, #001f7a 0%, #0048ff 100%);
            color: #fff;
            position: sticky; top: 0; z-index: 10;
        }
        .table th, .table td {
            text-align: center; vertical-align: middle; padding: 1.2rem;
        }
        .total-cell {
            background-color: #ffc107 !important; color: #000 !important; font-weight: bold;
        }
    </style>
</head>
<body>
<div class="container-tv">
    <!-- CABECERA -->
    <header>
        <img src="shooting_logo.png" alt="Logo Izquierdo" class="logo-izquierdo">
        <div class="text-center">
            <h1 class="display-5 fw-bold" id="titulo-disciplina">Resultados en Directo</h1>
            <div id="infoActualizacion" class="status-waiting mt-3 p-2 rounded mx-auto" style="max-width:60vw;">
                <div class="d-flex align-items-center justify-content-center">
                    <div class="spinner-border spinner-border-sm me-3" role="status"></div>
                    <span>Buscando canal de competición...</span>
                </div>
            </div>
        </div>
    </header>

    <!-- LOGO CENTRAL o TABLA -->
    <main id="contenido">
        <div id="logoCentral">
            <img src="trasona-logo.png" alt="Club de Tiro Ensidesa Trasona" class="logo-trasona">
        </div>
        <div class="table-container" id="tablasContainer" style="display: none;"></div>
    </main>
</div>

<script>
    const CANAL_UNIVERSAL_ID = '68e19505ae596e708f063783'; // Tu Bin ID universal
    let ultimoContenido = ''; // Caché para evitar redibujar si no hay cambios

    // Función principal que consulta los datos del servidor
    async function consultarCanal() {
        const infoElement = document.getElementById('infoActualizacion');

        try {
            // 1. Llama a la API de JSONBin para obtener la última versión de los datos
            const respuesta = await fetch(`https://api.jsonbin.io/v3/b/${CANAL_UNIVERSAL_ID}/latest`);

            if (!respuesta.ok) throw new Error(`Error de red: ${respuesta.status}`);

            // 2. Compara el contenido nuevo con el anterior para optimizar
            const contenidoTexto = await respuesta.text();
            if (contenidoTexto === ultimoContenido) {
                // Si no hay cambios, no hacemos nada. Esto ahorra recursos.
                return;
            }
            ultimoContenido = contenidoTexto; // Actualizamos la caché

            // 3. Procesa los datos recibidos
            const datos = JSON.parse(contenidoTexto).record;

            // Si el bin está vacío o no tiene datos válidos, salimos.
            if (!datos || !datos.tipo || !datos.datos) {
                 // Podríamos mostrar un mensaje de "Esperando inicio de competición"
                 return;
            }

            // 4. Muestra los resultados en la pantalla
            mostrarResultadosTV(datos);

            // Cambiamos el estado a "Conectado"
            infoElement.className = 'status-connected mt-3 p-2 rounded mx-auto';
            infoElement.innerHTML = `<div class="text-center"><span class="fw-bold">✅ EN DIRECTO: ${datos.disciplina.toUpperCase()}</span></div>`;

        } catch (error) {
            console.error("❌ Error al buscar datos:", error);
            infoElement.className = 'status-disconnected mt-3 p-2 rounded mx-auto';
            infoElement.innerHTML = `<div class="text-center">❌ Error de conexión. Reintentando...</div>`;
        }
    }

    function mostrarResultadosTV(datos) {
        const logoCentral = document.getElementById('logoCentral');
        const tablasContainer = document.getElementById('tablasContainer');
        const tiradores = datos.datos || []; // Los datos de los tiradores ahora son un array

        // Oculta el logo y muestra el contenedor de la tabla
        logoCentral.style.display = 'none';
        tablasContainer.style.display = 'block';

        // Actualiza el título principal de la disciplina
        document.getElementById('titulo-disciplina').textContent = datos.disciplina;

        // Si no hay tiradores, muestra un mensaje
        if (tiradores.length === 0) {
            tablasContainer.innerHTML = '<p style="font-size: 1.5rem; text-align: center;">No hay tiradores en esta competición.</p>';
            return;
        }

        // Generamos las cabeceras de la tabla dinámicamente
        const numSeries = Object.keys(tiradores[0].series).length;
        let seriesHeaders = '';
        for (let i = 1; i <= numSeries; i++) {
            seriesHeaders += `<th>S${i}</th>`;
        }

        // Construimos el HTML de la tabla
        let tablaHTML = `
            <table class="table table-dark table-bordered table-hover">
                <thead>
                    <tr>
                        <th>Puesto</th>
                        <th>Tirador</th>
                        ${seriesHeaders}
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>`;

        // Añadimos una fila por cada tirador (los datos ya vienen ordenados desde la app)
        tiradores.forEach((tirador, index) => {
            let seriesCells = '';
            for (let i = 1; i <= numSeries; i++) {
                // Usamos "?." por seguridad, si una serie no existe, muestra 0
                seriesCells += `<td>${tirador.series[i]?.total || 0}</td>`;
            }

            tablaHTML += `
                <tr>
                    <td class="fw-bold text-warning">${index + 1}º</td>
                    <td>${tirador.nombre}</td>
                    ${seriesCells}
                    <td class="total-cell">${tirador.total}</td>
                </tr>`;
        });

        tablaHTML += '</tbody></table>';
        tablasContainer.innerHTML = tablaHTML; // Insertamos la tabla en la página
    }

    // Al cargar la página, empezamos el ciclo de consulta
    document.addEventListener('DOMContentLoaded', function() {
        consultarCanal(); // Hacemos una consulta inmediata al cargar
        setInterval(consultarCanal, 400000); // 5000 son 5 seg
    });
</script>
</body>
</html>
