<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV - Resultados en Directo</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ¯</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background: radial-gradient(circle at center, #000428 0%, #004e92 100%); color: #fff; font-family: 'Rajdhani', sans-serif; margin:0; padding:0; overflow:hidden; }
        .container-tv { width:100%; height:100vh; display:flex; flex-direction:column; justify-content:flex-start; }
        header { position:relative; background:linear-gradient(90deg,#002bff 0%,#001242 100%); padding:1.5vh 3vw; border-bottom:0.5vh solid #ffc107; display:flex; align-items:center; justify-content:center; }
        .logo-izquierdo { position:absolute; left:3vw; height:clamp(40px, 8vh, 130px); filter:drop-shadow(0 0 10px rgba(255,255,255,0.7)); }
        h1.display-5 { font-size:clamp(2rem,4vw,4.5rem); text-transform:uppercase; text-shadow:0 0 25px rgba(255,255,255,0.9); margin:0; }
        .logo-trasona { display:block; margin:5vh auto 4vh; height:clamp(180px,35vh,380px); width:auto; filter:drop-shadow(0 0 30px rgba(255,255,255,0.8)); animation:aparecerLogo 1.5s ease-out; }
        @keyframes aparecerLogo { from {opacity:0; transform:scale(0.8);} to {opacity:1; transform:scale(1);} }
        .status-box { max-width:60vw; margin:1vh auto 0; padding:clamp(0.4rem, 1vw, 0.7rem); border-radius:0.5rem; font-size:clamp(0.7rem, 1.3vw, 1.7rem); font-weight:bold; text-align:center; }
        .status-connected { background: rgba(0,255,136,0.2); border:2px solid #00ff88; color:#00ff88; text-shadow:0 0 15px rgba(0,255,136,0.7); }
        .status-disconnected { background: rgba(255,0,60,0.2); border:2px solid #ff003c; color:#ff4d6d; }
        .table-container { flex-grow:1; overflow-y:auto; scroll-behavior:smooth; margin:2vh auto; width:95%; max-height: 70vh; }
        .table { font-size:clamp(1rem,2vw,2.5rem); border-color:#00bfff; color:#fff; background:rgba(0,60,150,0.3); backdrop-filter:blur(8px); min-width:1500px; }
        .table thead { background: linear-gradient(90deg,#001f7a 0%,#0048ff 100%); color:#fff; text-transform:uppercase; border-bottom:0.5vh solid #ffc107; position:sticky; top:0; z-index:10; font-size:clamp(1rem,1.6vw,2rem); }
        .table th,.table td { text-align:center; vertical-align:middle; padding:1.2rem; }
        .table-success { background-color:rgba(0,255,136,0.25)!important; color:#00ff9c; font-weight:700; }
        .table-info { background-color:rgba(0,229,255,0.25)!important; color:#00d8ff; font-weight:700; }
        tr:hover { background-color:rgba(255,255,255,0.08); }
        .resultados-header { position:sticky; top:0; background:radial-gradient(circle at top, rgba(0,10,60,0.98), rgba(0,10,30,0.95)); padding:1.5vh 0; text-align:center; font-size:clamp(1.6rem,3vw,3rem); color:#ffc107; text-transform:uppercase; font-weight:700; z-index:25; box-shadow:0 6px 12px rgba(0,0,0,0.5); margin-bottom: 1vh; }
        .contador-actualizacion { font-size:clamp(1rem,1.5vw,1.6rem); color:#00e6ff; text-shadow:0 0 8px rgba(0,230,255,0.9); margin-top:0.5vh; }
    </style>
</head>
<body>

<div id="mainContent" class="container-tv" style="display: none; flex-direction: column;">
  <header>
    <img src="shooting_logo.png" alt="Logo Izquierdo" class="logo-izquierdo" onerror="this.style.display='none'">
    <div class="text-center">
      <h1 class="display-5 fw-bold">Resultados en Directo</h1>
      <div id="infoActualizacion" class="status-box rounded mx-auto" style="display:none;"></div>
    </div>
  </header>
  <div id="logoCentral">
    <img src="trasona-logo.png" alt="Club de Tiro Ensidesa Trasona" class="logo-trasona" onerror="this.style.display='none'">
  </div>
  <main id="contenido">
    <div class="table-container" id="tablasContainer" style="display:none;"></div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- CONFIGURACIÃ“N ---
    const DATOS_COMPETICION_BIN_ID = '68ed56de43b1c97be96636cc'; // El Bin con los resultados
    const CODIGO_ACCESO_BIN_ID = 'ID_DE_TU_BIN_DE_CODIGO_DE_ACCESO'; // âœ… PEGA AQUÃ LA ID DEL BIN QUE USA MAINACTIVITY
    const INTERVALO_ACTUALIZACION = 10000; // Chequea cada 10 segundos
    
    let ultimoContenidoResultados = '';
    let ultimoComandoControl = '';
    let updateIntervalId = null;

    // --- ELEMENTOS DEL DOM ---
    const mainContent = document.getElementById('mainContent');
    const infoElement = document.getElementById('infoActualizacion');
    const logoCentral = document.getElementById('logoCentral');
    const tablasContainer = document.getElementById('tablasContainer');

    // --- LÃ“GICA DE INICIO ---
    document.addEventListener('DOMContentLoaded', () => {
        mainContent.style.display = 'flex';
        mostrarEscudo(); // La TV siempre empieza mostrando el escudo
        iniciarChequeos();
    });

    function mostrarEscudo() {
        console.log("ðŸ›¡ï¸ Mostrando el escudo del club.");
        logoCentral.style.display = 'block';
        tablasContainer.style.display = 'none';
        infoElement.style.display = 'none';
    }

    function iniciarChequeos() {
        if (updateIntervalId) clearInterval(updateIntervalId);
        chequeoPeriodico(); // Primera llamada inmediata
        updateIntervalId = setInterval(chequeoPeriodico, INTERVALO_ACTUALIZACION);
    }

    async function chequeoPeriodico() {
        try {
            // 1. Primero, consultamos el canal de control
            const controlResponse = await fetch(`https://api.jsonbin.io/v3/b/${CODIGO_ACCESO_BIN_ID}/latest`);
            if (controlResponse.ok) {
                const controlData = (await controlResponse.json()).record;
                const nuevoComando = controlData.comando;

                // Si la orden es "mostrar_escudo" y es una orden nueva
                if (nuevoComando !== ultimoComandoControl && nuevoComando === 'mostrar_escudo') {
                    console.log("ðŸ”´ Â¡SeÃ±al de reinicio recibida! Volviendo al escudo.");
                    ultimoComandoControl = nuevoComando;
                    mostrarEscudo();
                    // Al recibir la orden, tambiÃ©n limpiamos el contenido de resultados para forzar una recarga visual la prÃ³xima vez
                    ultimoContenidoResultados = ''; 
                    return; // Detenemos este ciclo para mostrar el escudo inmediatamente
                }
                ultimoComandoControl = nuevoComando;
            }

            // 2. Si no hay orden de reinicio, consultamos los resultados
            const resultadosResponse = await fetch(`https://api.jsonbin.io/v3/b/${DATOS_COMPETICION_BIN_ID}/latest`);
            if (!resultadosResponse.ok) return; // Si no hay resultados, no hacemos nada

            const contenidoTexto = await resultadosResponse.text();
            if (contenidoTexto === ultimoContenidoResultados) return;
            ultimoContenidoResultados = contenidoTexto;

            const datos = JSON.parse(contenidoTexto).record;
            
            // Si hay datos de competiciÃ³n vÃ¡lidos, mostramos la tabla
            if (datos && datos.datos && datos.datos.length > 0) {
                mostrarResultados(datos);
            }

        } catch (error) {
            console.error("Error en el chequeo periÃ³dico:", error.message);
        }
    }

    function mostrarResultados(datos) {
        const datosTraducidos = datos.datos.map(tirador => ({
            ...tirador,
            nombre: tirador.nombre || `Tirador ${tirador.puesto}`
        }));

        const datosParaTabla = {
            disciplina: datos.disciplina || 'Resultados en Directo',
            datos: datosTraducidos
        };

        logoCentral.style.display = 'none';
        tablasContainer.style.display = 'block';
        infoElement.style.display = 'block';
        mostrarTablaUnificada(datosParaTabla);
        
        infoElement.className = 'status-box status-connected';
        infoElement.innerHTML = `
          <div class="text-center">
            <span class="fw-bold"><i class="bi bi-check-circle-fill"></i> EN DIRECTO</span><br>
            <small>${(datos.disciplina || '').toUpperCase()}</small>
            <div class="contador-actualizacion">Actualizado: ${new Date().toLocaleTimeString()}</div>
          </div>`;
    }

    function mostrarTablaUnificada(datos) {
        const resultados = datos.datos || [];
        const container = document.getElementById('tablasContainer');
        
        if (!resultados.length) {
            mostrarEscudo(); // Si no hay resultados, muestra el escudo
            return;
        }

        const seriesData = resultados[0].series || resultados[0].parciales || [];
        const numSeries = seriesData.length;

        let tablaHTML = `<div class="resultados-header">${datos.disciplina}</div><div class="table-scroll-wrapper"><table class="table table-dark table-bordered table-hover"><thead><tr><th>Pos.</th><th>Puesto</th><th>Nombre</th>${Array.from({ length: numSeries }, (_, i) => `<th>S${i+1}</th>`).join('')}<th>Total</th><th>X</th></tr></thead><tbody>`;
        
        resultados.sort((a,b) => parseFloat(b.total)-parseFloat(a.total) || parseFloat(b.xTotal)-parseFloat(a.xTotal));
        
        resultados.forEach((r,index) => {
            const seriesColumnas = r.series || r.parciales || [];
            tablaHTML += `<tr><td class="fw-bold text-warning">${index+1}Âº</td><td>Puesto ${r.puesto || '-'}</td><td>${r.nombre || 'AnÃ³nimo'}</td>${seriesColumnas.map(s => `<td>${s !== null ? s : '-'}</td>`).join('')}<td class="table-success fw-bold">${r.total}</td><td class="table-info fw-bold">${r.xTotal}</td></tr>`;
        });

        tablaHTML += '</tbody></table></div>';
        container.innerHTML = tablaHTML;
    }
</script>

</body>
</html>
