<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TV - Resultados en Directo</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
  body { background: radial-gradient(circle at center, #000428 0%, #004e92 100%); color: #fff; font-family: 'Rajdhani', sans-serif; margin:0; padding:0; overflow:hidden;}
  .container-tv {width:100%; height:100vh; display:flex; flex-direction:column; justify-content:flex-start;}
  header {position:relative; background:linear-gradient(90deg,#002bff 0%,#001242 100%); padding:1.5vh 3vw; border-bottom:0.5vh solid #ffc107; display:flex; align-items:center; justify-content:space-between;}
  .logo-izquierdo {height:clamp(40px, 8vh, 130px);}
  h1.display-5 {font-size:clamp(2rem,4vw,4.5rem); text-transform:uppercase; text-shadow:0 0 25px rgba(255,255,255,0.9); margin:0; display:inline-block;}
  .update-time {font-size:clamp(0.9rem,1.5vw,1.3rem); color:#00e6ff; text-shadow:0 0 8px rgba(0,230,255,0.9); margin-left:1rem;}
  .table-container {flex-grow:1; overflow-y:auto; scroll-behavior:smooth; margin:2vh auto; width:95%; max-height:80vh;}
  .table {font-size:clamp(1rem,2vw,2.5rem); border-color:#00bfff; color:#fff; background:rgba(0,60,150,0.3); backdrop-filter:blur(8px); min-width:1500px;}
  .table thead {background: linear-gradient(90deg,#001f7a 0%,#0048ff 100%); color:#fff; text-transform:uppercase; border-bottom:0.5vh solid #ffc107; position:sticky; top:0; z-index:10; font-size:clamp(1rem,1.6vw,2rem);}
  .table th,.table td {text-align:center; vertical-align:middle; padding:1.2rem;}
  .table-success {background-color:rgba(0,255,136,0.25)!important; color:#00ff9c; font-weight:700;}
  .table-info {background-color:rgba(0,229,255,0.25)!important; color:#00d8ff; font-weight:700;}
  tr:hover {background-color:rgba(255,255,255,0.08);}
  .resultados-header {background:radial-gradient(circle at top, rgba(0,10,60,0.98), rgba(0,10,30,0.95)); padding:1.5vh 0; text-align:center; font-size:clamp(1.6rem,3vw,3rem); color:#ffc107; text-transform:uppercase; font-weight:700; z-index:25; box-shadow:0 6px 12px rgba(0,0,0,0.5); margin-bottom:1vh;}
</style>
</head>
<body>
<div class="container-tv">
  <header>
    <h1 class="display-5">Resultados en Directo</h1>
    <span class="update-time" id="updateTime"></span>
  </header>
  <main class="flex-grow-1 d-flex flex-column">
    <div id="tablasContainer" class="table-container"></div>
  </main>
</div>

<script>
const DATOS_COMPETICION_BIN_ID = '68ed56de43b1c97be96636cc'; // Bin de resultados
const INTERVALO_ACTUALIZACION = 10000; // Cada 10s
const CODIGO_ACCESO_CORRECTO = '1234'; // Cambia aquí tu código de acceso

const tablasContainer = document.getElementById('tablasContainer');
const updateTimeElement = document.getElementById('updateTime');
let ultimoContenidoResultados = '';

// --- Solicitar código de acceso ---
let intento = prompt("Introduce el código de acceso:");
if (intento !== CODIGO_ACCESO_CORRECTO) {
  tablasContainer.innerHTML = '<div class="text-center mt-5 fs-3 text-warning">Acceso denegado</div>';
} else {
  cargarResultados();
  setInterval(cargarResultados, INTERVALO_ACTUALIZACION);
}

// --- Funciones ---
async function cargarResultados() {
  try {
    const response = await fetch(`https://api.jsonbin.io/v3/b/${DATOS_COMPETICION_BIN_ID}/latest`);
    if (!response.ok) throw new Error("No se pudieron obtener resultados");

    const contenidoTexto = await response.text();
    if (contenidoTexto === ultimoContenidoResultados) return;
    ultimoContenidoResultados = contenidoTexto;

    const datos = JSON.parse(contenidoTexto).record;
    if (Array.isArray(datos?.datos) && datos.datos.length) {
      mostrarTabla(datos);
    } else {
      tablasContainer.innerHTML = '<div class="text-center mt-5 fs-3 text-warning">Sin datos disponibles</div>';
    }

    const ahora = new Date();
    updateTimeElement.textContent = `${ahora.toLocaleDateString()} ${ahora.toLocaleTimeString()}`;
  } catch (err) {
    console.error(err.message);
    tablasContainer.innerHTML = `<div class="text-center mt-5 fs-3 text-danger">Error al cargar resultados</div>`;
  }
}

function mostrarTabla(datos) {
  const resultados = datos.datos || [];
  const seriesData = resultados[0]?.series || resultados[0]?.parciales || [];
  const numSeries = seriesData.length;

  resultados.sort((a,b) => parseFloat(b.total)-parseFloat(a.total) || parseFloat(b.xTotal)-parseFloat(a.xTotal));

  let tablaHTML = `
    <div class="resultados-header">${datos.disciplina || 'Competición'}</div>
    <table class="table table-dark table-bordered table-hover">
      <thead>
        <tr>
          <th>Pos.</th>
          <th>Puesto</th>
          ${Array.from({ length: numSeries }, (_, i) => `<th>S${i+1}</th>`).join('')}
          <th>Total</th>
          <th>X</th>
        </tr>
      </thead>
      <tbody>`;

  resultados.forEach((r,index) => {
    const seriesColumnas = r.series || r.parciales || [];
    tablaHTML += `
      <tr>
        <td class="fw-bold text-warning">${index+1}º</td>
        <td>Puesto ${r.puesto || '-'}</td>
        ${seriesColumnas.map(s => `<td>${s ?? '-'}</td>`).join('')}
        <td class="table-success fw-bold">${r.total}</td>
        <td class="table-info fw-bold">${r.xTotal}</td>
      </tr>`;
  });

  tablaHTML += '</tbody></table>';
  tablasContainer.innerHTML = tablaHTML;
}
</script>
</body>
</html>
