<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TV - Resultados Tiro Deportivo</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">

<style>
    body {
        background: radial-gradient(circle at center, #000428 0%, #004e92 100%);
        color: #ffffff;
        font-family: 'Rajdhani', sans-serif;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    .container-tv {
        width: 100%;
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
    }

    /* ===== CABECERA ===== */
    header {
        position: relative;
        background: linear-gradient(90deg, #002bff 0%, #001242 100%);
        color: white;
        padding: 2vh 5vw;
        border-bottom: 0.5vh solid #ffc107;
        box-shadow: 0 8px 40px rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .logo-izquierdo {
        position: absolute;
        left: 3vw;
        height: clamp(60px, 10vh, 130px);
        width: auto;
        filter: drop-shadow(0 0 10px rgba(255,255,255,0.7));
    }

    h1.display-5 {
        font-size: clamp(2rem, 4vw, 4.5rem);
        text-transform: uppercase;
        letter-spacing: 0.2vw;
        text-shadow: 0 0 25px rgba(255,255,255,0.9);
        margin: 0;
        text-align: center;
    }

    /* ===== LOGO CENTRAL ===== */
    .logo-trasona {
        display: block;
        margin: 5vh auto 4vh;
        height: clamp(180px, 35vh, 380px);
        width: auto;
        filter: drop-shadow(0 0 30px rgba(255,255,255,0.8));
        animation: aparecerLogo 1.5s ease-out;
    }

    @keyframes aparecerLogo {
        from { opacity: 0; transform: scale(0.8); }
        to { opacity: 1; transform: scale(1); }
    }

    /* ===== ESTADOS ===== */
    .status-connected {
        background: rgba(0,255,136,0.2);
        border: 2px solid #00ff88;
        color: #00ff88;
        font-weight: bold;
        text-shadow: 0 0 15px rgba(0,255,136,0.7);
        font-size: clamp(1rem, 1.8vw, 1.8rem);
        margin-top: 1vh;
    }

    .status-disconnected {
        background: rgba(255,0,60,0.2);
        border: 2px solid #ff003c;
        color: #ff4d6d;
    }

    .status-waiting {
        background: rgba(255,255,0,0.2);
        border: 2px solid #ffe600;
        color: #ffe600;
    }

    /* ===== TABLAS ===== */
    .table-container {
        flex-grow: 1;
        overflow-y: auto;
        scroll-behavior: smooth;
        margin: 2vh auto;
        width: 95%;
        border-radius: 1vh;
    }

    .table {
        font-size: clamp(1rem, 2vw, 2.5rem);
        border-color: #00bfff;
        color: #ffffff;
        background: rgba(0, 60, 150, 0.3);
        backdrop-filter: blur(8px);
        min-width: 1500px;
    }

    .table thead {
        background: linear-gradient(90deg, #001f7a 0%, #0048ff 100%);
        color: #fff;
        text-transform: uppercase;
        border-bottom: 0.5vh solid #ffc107;
        position: sticky;
        top: 0;
        z-index: 10;
        font-size: clamp(1rem, 1.6vw, 2rem);
    }

    .table th, .table td {
        text-align: center;
        vertical-align: middle;
        padding: 1.2rem;
    }

    .table-success { background-color: rgba(0,255,136,0.25) !important; color: #00ff9c; font-weight: 700; }
    .table-info { background-color: rgba(0,229,255,0.25) !important; color: #00d8ff; font-weight: 700; }
    tr:hover { background-color: rgba(255,255,255,0.08); }

    /* ===== CABECERA RESULTADOS ===== */
    .resultados-header {
        position: sticky;
        top: 0;
        background: radial-gradient(circle at top, rgba(0,10,60,0.95), rgba(0,10,30,0.9));
        padding: 1vh 0;
        text-align: center;
        font-size: clamp(1.6rem, 3vw, 3rem);
        color: #ffc107;
        text-transform: uppercase;
        font-weight: 700;
        z-index: 20;
        box-shadow: 0 6px 12px rgba(0,0,0,0.5);
    }

    .contador-actualizacion {
        font-size: clamp(1rem, 1.5vw, 1.6rem);
        color: #00e6ff;
        text-shadow: 0 0 8px rgba(0,230,255,0.9);
        margin-top: 0.5vh;
    }
</style>
</head>
<body>
<div class="container-tv">

    <!-- CABECERA -->
    <header>
        <img src="shooting_logo.png" alt="Logo Izquierdo" class="logo-izquierdo">
        <div class="text-center">
            <h1 class="display-5 fw-bold">Resultados en Directo</h1>
            <div id="infoActualizacion" class="status-waiting mt-3 p-2 rounded mx-auto" style="max-width:60vw;">
                <div class="d-flex align-items-center justify-content-center">
                    <div class="spinner-border spinner-border-sm me-3" role="status"></div>
                    <span>Buscando canal de competición...</span>
                </div>
            </div>
        </div>
    </header>

    <!-- LOGO CENTRAL -->
    <div id="logoCentral">
        <img src="trasona-logo.png" alt="Club de Tiro Ensidesa Trasona" class="logo-trasona">
    </div>

    <!-- TABLA -->
    <main id="contenido">
        <div class="table-container" id="tablasContainer" style="display: none;"></div>
    </main>
</div>

<script>
const CANAL_UNIVERSAL_ID = '68e19505ae596e708f063783';
const INTERVALO_ACTUALIZACION = 400000; // 400 segundos = 6 minutos 40 segundos
let ultimoContenido = '';
let tiempoRestante = INTERVALO_ACTUALIZACION / 1000;
let contadorIntervalo;

async function consultarCanal() {
    const infoElement = document.getElementById('infoActualizacion');
    const logoCentral = document.getElementById('logoCentral');
    const tablasContainer = document.getElementById('tablasContainer');

    try {
        const respuesta = await fetch(`https://api.jsonbin.io/v3/b/${CANAL_UNIVERSAL_ID}/latest`);
        if (!respuesta.ok) throw new Error(`Error ${respuesta.status}`);
        const contenidoTexto = await respuesta.text();
        if (contenidoTexto === ultimoContenido) return;
        ultimoContenido = contenidoTexto;
        const datos = JSON.parse(contenidoTexto).record;
        if (!datos || !datos.datos) return;

        mostrarTablaUnificada(datos);
        logoCentral.style.display = 'none';
        tablasContainer.style.display = 'block';

        infoElement.className = 'status-connected p-3 rounded mx-auto';
        infoElement.innerHTML = `
            <div class="text-center">
                <span class="fw-bold">✅ EN DIRECTO</span><br>
                <small>${datos.disciplina.toUpperCase()}</small>
                <div class="contador-actualizacion" id="contador">Próxima actualización en: —</div>
            </div>`;
        reiniciarContador();
    } catch (error) {
        console.error("❌ Error al buscar datos:", error);
        infoElement.className = 'status-disconnected p-3 rounded mx-auto';
        infoElement.innerHTML = `<div class="text-center">❌ Error al recibir datos. Verificando...</div>`;
    }
}

function reiniciarContador() {
    tiempoRestante = INTERVALO_ACTUALIZACION / 1000;
    clearInterval(contadorIntervalo);
    actualizarContador();
    contadorIntervalo = setInterval(() => {
        tiempoRestante--;
        if (tiempoRestante <= 0) {
            consultarCanal();
        } else {
            actualizarContador();
        }
    }, 1000);
}

function actualizarContador() {
    const contador = document.getElementById('contador');
    if (!contador) return;
    const minutos = Math.floor(tiempoRestante / 60);
    const segundos = tiempoRestante % 60;
    contador.textContent = `Próxima actualización en: ${minutos}m ${segundos}s`;
}

document.addEventListener('DOMContentLoaded', function() {
    consultarCanal();
    setInterval(consultarCanal, INTERVALO_ACTUALIZACION);
});

function mostrarTablaUnificada(datos) {
    const container = document.getElementById('tablasContainer');
    const resultados = datos.datos || [];

    if (!resultados.length) {
        container.innerHTML = `<h2 class="text-center text-warning">Sin datos disponibles</h2>`;
        return;
    }

    const numSeries = resultados[0].series ? resultados[0].series.length : resultados[0].parciales?.length || 0;
    let tablaHTML = `
    <div class="resultados-header">${datos.disciplina}</div>
    <div class="scroll-animado table-wrapper">
    <table class="table table-dark table-bordered table-hover">
        <thead><tr>
            <th>Pos.</th><th>Puesto</th>
            ${Array.from({ length: numSeries }, (_, i) => `<th>S${i+1}</th>`).join('')}
            <th>Total</th><th>X</th>
        </tr></thead><tbody>`;

    resultados.forEach((r, index) => {
        const series = r.series || r.parciales || [];
        tablaHTML += `<tr>
            <td class="fw-bold text-warning">${index + 1}º</td>
            <td>Puesto ${r.puesto}</td>
            ${series.map(s => `<td>${s}</td>`).join('')}
            <td class="table-success fw-bold">${r.total}</td>
            <td class="table-info fw-bold">${r.xTotal}</td>
        </tr>`;
    });

    tablaHTML += '</tbody></table></div>';
    container.innerHTML = tablaHTML;
}
</script>
</body>
</html>
