<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV - Conexión a Resultados</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🎯</text></svg>">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background: radial-gradient(circle at center, #000428 0%, #004e92 100%); color: #fff; font-family: 'Rajdhani', sans-serif; margin:0; padding:0; overflow:hidden; }
        .container-tv { width:100%; height:100vh; display:flex; flex-direction:column; justify-content:flex-start; }
        header { position:relative; background:linear-gradient(90deg,#002bff 0%,#001242 100%); padding:1.5vh 3vw; border-bottom:0.5vh solid #ffc107; display:flex; align-items:center; justify-content:center; }
        .logo-izquierdo { position:absolute; left:3vw; height:clamp(60px,10vh,130px); filter:drop-shadow(0 0 10px rgba(255,255,255,0.7)); }
        h1.display-5 { font-size:clamp(2rem,4vw,4.5rem); text-transform:uppercase; text-shadow:0 0 25px rgba(255,255,255,0.9); margin:0; }
        .logo-trasona { display:block; margin:5vh auto 4vh; height:clamp(180px,35vh,380px); width:auto; filter:drop-shadow(0 0 30px rgba(255,255,255,0.8)); animation:aparecerLogo 1.5s ease-out; }
        @keyframes aparecerLogo { from {opacity:0; transform:scale(0.8);} to {opacity:1; transform:scale(1);} }
        .status-box { max-width:60vw; margin:1vh auto 0; padding:0.7rem; border-radius:0.5rem; font-size:clamp(1rem,1.6vw,1.7rem); font-weight:bold; text-align:center; }
        .status-connected { background: rgba(0,255,136,0.2); border:2px solid #00ff88; color:#00ff88; text-shadow:0 0 15px rgba(0,255,136,0.7); }
        .status-disconnected { background: rgba(255,0,60,0.2); border:2px solid #ff003c; color:#ff4d6d; }
        .status-finalizado { background: rgba(255,193,7,0.2); border:2px solid #ffc107; color:#ffc107; text-shadow:0 0 15px rgba(255,193,7,0.7); }
        .table-container { 
            flex-grow:1; 
            overflow-y:auto; 
            scroll-behavior:smooth; 
            margin:2vh auto; 
            width:95%; 
            max-height: 70vh;
            position: relative;
        }
        .table-container::-webkit-scrollbar {
            width: 12px;
        }
        .table-container::-webkit-scrollbar-track {
            background: rgba(0, 20, 50, 0.5);
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #0048ff, #00bfff);
            border-radius: 10px;
            border: 2px solid rgba(0, 20, 50, 0.5);
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #00bfff, #0048ff);
        }
        .table { font-size:clamp(1rem,2vw,2.5rem); border-color:#00bfff; color:#fff; background:rgba(0,60,150,0.3); backdrop-filter:blur(8px); min-width:1500px; }
        .table thead { background: linear-gradient(90deg,#001f7a 0%,#0048ff 100%); color:#fff; text-transform:uppercase; border-bottom:0.5vh solid #ffc107; position:sticky; top:0; z-index:10; font-size:clamp(1rem,1.6vw,2rem); }
        
        .scroll-indicator {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 193, 7, 0.9);
            color: #000;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: bold;
            z-index: 15;
            animation: bounce 2s infinite;
            pointer-events: none;
        }
        @keyframes bounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }
        
        .table tbody tr {
            transition: all 0.3s ease;
        }
        .table tbody tr.highlight-row {
            background-color: rgba(255, 193, 7, 0.2) !important;
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.4);
        }
        .table th,.table td { text-align:center; vertical-align:middle; padding:1.2rem; }
        .table-success { background-color:rgba(0,255,136,0.25)!important; color:#00ff9c; font-weight:700; }
        .table-info { background-color:rgba(0,229,255,0.25)!important; color:#00d8ff; font-weight:700; }
        tr:hover { background-color:rgba(255,255,255,0.08); }
        .resultados-header { 
            position:sticky; 
            top:0; 
            background:radial-gradient(circle at top, rgba(0,10,60,0.98), rgba(0,10,30,0.95)); 
            padding:1.5vh 0; 
            text-align:center; 
            font-size:clamp(1.6rem,3vw,3rem); 
            color:#ffc107; 
            text-transform:uppercase; 
            font-weight:700; 
            z-index:25; 
            box-shadow:0 6px 12px rgba(0,0,0,0.5);
            margin-bottom: 1vh;
        }
        
        .table-scroll-wrapper {
            max-height: 65vh;
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .table-scroll-wrapper::-webkit-scrollbar {
            width: 12px;
        }
        .table-scroll-wrapper::-webkit-scrollbar-track {
            background: rgba(0, 20, 50, 0.5);
            border-radius: 10px;
        }
        .table-scroll-wrapper::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #0048ff, #00bfff);
            border-radius: 10px;
            border: 2px solid rgba(0, 20, 50, 0.5);
        }
        .table-scroll-wrapper::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #00bfff, #0048ff);
        }
        .contador-actualizacion { font-size:clamp(1rem,1.5vw,1.6rem); color:#00e6ff; text-shadow:0 0 8px rgba(0,230,255,0.9); margin-top:0.5vh; }
        
        .badge-tipo {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            font-weight: bold;
        }
        .badge-seguimiento { background: rgba(0,123,255,0.3); border: 2px solid #007bff; color: #00d8ff; }
        .badge-resultado { background: rgba(40,167,69,0.3); border: 2px solid #28a745; color: #00ff88; }
        
        /* ESTILOS PARA FINALIZACIÓN */
        .mensaje-finalizacion {
            text-align: center;
            margin-top: 3vh;
            animation: fadeInScale 1.5s ease-out;
        }
        .mensaje-finalizacion h2 {
            font-size: clamp(2.5rem, 5vw, 5rem);
            color: #ffc107;
            text-shadow: 0 0 30px rgba(255, 193, 7, 0.8);
            margin-bottom: 2vh;
        }
        .mensaje-finalizacion .info-final {
            font-size: clamp(1.2rem, 2vw, 2.5rem);
            color: #00d8ff;
            margin: 1vh 0;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .btn-reactivar {
            margin-top: 3vh;
            padding: 1rem 3rem;
            font-size: clamp(1rem, 1.5vw, 1.8rem);
            font-weight: bold;
            background: linear-gradient(90deg, #ffc107, #ff9800);
            border: none;
            border-radius: 0.5rem;
            color: #000;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.5);
        }
        .btn-reactivar:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 193, 7, 0.8);
        }
        
        /* Transición suave al cambiar vistas */
        .fade-transition {
            animation: fadeIn 0.8s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>

<div class="modal fade" id="modalAcceso" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white" style="backdrop-filter: blur(10px); background: rgba(0,20,50,0.7) !important;">
      <div class="modal-header border-secondary">
        <h5 class="modal-title">🎯 Conexión a Resultados en Directo</h5>
      </div>
      <div class="modal-body text-center">
        <p>Introduce el código de acceso de 4 dígitos.</p>
        <form id="formAcceso">
          <input type="text" id="accessCodeInput" class="form-control form-control-lg text-center my-3" maxlength="4" placeholder="----" required autocomplete="off">
          <button type="submit" class="btn btn-primary btn-lg w-100">
            <span class="spinner-border spinner-border-sm d-none me-2" role="status"></span>
            Conectar
          </button>
          <div id="errorMessage" class="text-danger mt-3" style="height:24px; font-size: 0.9rem;"></div>
        </form>
        <div class="mt-3">
          <small class="text-muted">Código por defecto: 1234</small>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="mainContent" class="container-tv" style="display: none; flex-direction: column;">
  <header>
    <img src="shooting_logo.png" alt="Logo Izquierdo" class="logo-izquierdo" onerror="this.style.display='none'">
    <div class="text-center">
      <h1 class="display-5 fw-bold">Resultados en Directo</h1>
      <div id="infoActualizacion" class="status-box rounded mx-auto" style="display:none;"></div>
    </div>
    <div id="badgeTipo" class="badge-tipo" style="display:none;"></div>
  </header>
  <div id="logoCentral">
    <img src="trasona-logo.png" alt="Club de Tiro Ensidesa Trasona" class="logo-trasona" onerror="this.style.display='none'">
    <div id="mensajeFinalizacion" class="mensaje-finalizacion" style="display:none;">
      <h2>🏁 COMPETICIÓN FINALIZADA</h2>
      <div class="info-final">
        <p id="disciplinaFinal"></p>
        <p id="horaFinalizacion"></p>
      </div>
      <button class="btn-reactivar" onclick="reactivarSistema()">
        <i class="bi bi-arrow-clockwise"></i> Reactivar Sistema
      </button>
    </div>
  </div>
  <main id="contenido">
    <div class="table-container" id="tablasContainer" style="display:none;"></div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- CONFIGURACIÓN ---
    const DATOS_COMPETICION_BIN_ID = '68ed56de43b1c97be96636cc';
    const INTERVALO_ACTUALIZACION = 240000; // 4 minutos
    const TIMEOUT_FINALIZACION = 30 * 60 * 1000; // 30 minutos
    const INTERVALO_CHEQUEO_TIMEOUT = 60000; // 1 minuto
    
    let ultimoContenido = '';
    let ultimaActualizacion = Date.now();
    let competicionFinalizada = false;
    let disciplinaGuardada = '';

    // --- ELEMENTOS DEL DOM ---
    const modalAcceso = new bootstrap.Modal('#modalAcceso');
    const formAcceso = document.getElementById('formAcceso');
    const accessCodeInput = document.getElementById('accessCodeInput');
    const errorMessage = document.getElementById('errorMessage');
    const spinner = formAcceso.querySelector('.spinner-border');
    const mainContent = document.getElementById('mainContent');
    const infoElement = document.getElementById('infoActualizacion');
    const logoCentral = document.getElementById('logoCentral');
    const tablasContainer = document.getElementById('tablasContainer');
    const badgeTipo = document.getElementById('badgeTipo');
    const mensajeFinalizacion = document.getElementById('mensajeFinalizacion');
    const disciplinaFinal = document.getElementById('disciplinaFinal');
    const horaFinalizacion = document.getElementById('horaFinalizacion');

    // --- LÓGICA DE INICIO ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log('✅ Sistema TV iniciado');
        console.log('📡 Bin ID:', DATOS_COMPETICION_BIN_ID);
        
        if (sessionStorage.getItem('acceso_concedido_tv') === 'true') {
            console.log('✅ Sesión activa detectada');
            mainContent.style.display = 'flex';
            iniciarCargaDeResultados();
        } else {
            console.log('🔐 Mostrando modal de acceso');
            modalAcceso.show();
        }
        
        accessCodeInput.focus();
    });

    // --- LÓGICA DE ACCESO ---
    formAcceso.addEventListener('submit', async (e) => {
        e.preventDefault();
        const codigoIntroducido = accessCodeInput.value.trim();
        
        console.log('🔑 Intentando conectar con código:', codigoIntroducido);
        
        spinner.classList.remove('d-none');
        formAcceso.querySelector('button').disabled = true;
        errorMessage.textContent = '';

        try {
            console.log('📡 Consultando Bin...');
            const response = await fetch(`https://api.jsonbin.io/v3/b/${DATOS_COMPETICION_BIN_ID}/latest`);
            
            if (!response.ok) {
                throw new Error(`Error ${response.status}: No se pudo conectar con el servidor`);
            }
            
            const data = (await response.json()).record;
            console.log('📦 Datos recibidos:', data);
            
            if (typeof data.codigo_acceso === 'undefined') {
                console.error('❌ Estructura del Bin incorrecta:', data);
                throw new Error('Configuración del servidor incorrecta. Contacta al administrador.');
            }
            
            const codigoCorrecto = String(data.codigo_acceso);
            console.log('🔐 Código correcto:', codigoCorrecto);

            if (codigoIntroducido === codigoCorrecto) {
                console.log('✅ Acceso concedido');
                sessionStorage.setItem('acceso_concedido_tv', 'true');
                modalAcceso.hide();
                mainContent.style.display = 'flex';
                
                mostrarResultados(data);
                iniciarCargaDeResultados();
            } else {
                console.warn('❌ Código incorrecto');
                throw new Error('Código de acceso incorrecto');
            }
        } catch (error) {
            console.error('❌ Error en conexión:', error);
            errorMessage.textContent = error.message;
        } finally {
            spinner.classList.add('d-none');
            formAcceso.querySelector('button').disabled = false;
        }
    });
    
    // --- LÓGICA DE CARGA PERIÓDICA ---
    let intervaloActualizacion;
    let intervaloChequeoTimeout;
    
    function iniciarCargaDeResultados() {
        console.log('🔄 Iniciando actualizaciones automáticas');
        
        // Resetear estado
        competicionFinalizada = false;
        ultimaActualizacion = Date.now();
        
        // Carga inicial inmediata
        consultarResultados();
        
        // Configurar actualizaciones periódicas
        if (intervaloActualizacion) {
            clearInterval(intervaloActualizacion);
        }
        intervaloActualizacion = setInterval(consultarResultados, INTERVALO_ACTUALIZACION);
        
        // Configurar chequeo de timeout
        if (intervaloChequeoTimeout) {
            clearInterval(intervaloChequeoTimeout);
        }
        intervaloChequeoTimeout = setInterval(verificarTimeout, INTERVALO_CHEQUEO_TIMEOUT);
    }

    // --- VERIFICAR TIMEOUT DE 30 MINUTOS ---
    function verificarTimeout() {
        if (competicionFinalizada) return;
        
        const tiempoSinActualizar = Date.now() - ultimaActualizacion;
        const minutosTranscurridos = Math.floor(tiempoSinActualizar / 60000);
        
        console.log(`⏱️ Tiempo sin actualizaciones: ${minutosTranscurridos} minutos`);
        
        if (tiempoSinActualizar >= TIMEOUT_FINALIZACION) {
            console.log('🏁 Timeout alcanzado - Finalizando competición');
            finalizarCompeticion();
        }
    }

    // --- FINALIZAR COMPETICIÓN ---
    function finalizarCompeticion() {
        competicionFinalizada = true;
        
        // Detener todas las consultas
        if (intervaloActualizacion) {
            clearInterval(intervaloActualizacion);
        }
        if (intervaloChequeoTimeout) {
            clearInterval(intervaloChequeoTimeout);
        }
        if (autoScrollInterval) {
            clearInterval(autoScrollInterval);
        }
        
        console.log('✅ Sistema detenido - Mostrando pantalla final');
        
        // Guardar datos finales
        const horaFin = new Date();
        disciplinaFinal.textContent = disciplinaGuardada || 'Competición';
        horaFinalizacion.textContent = `Finalizado: ${horaFin.toLocaleTimeString()} - ${horaFin.toLocaleDateString()}`;
        
        // Transición suave
        tablasContainer.classList.add('fade-transition');
        logoCentral.classList.add('fade-transition');
        
        // Ocultar tabla y mostrar logo con mensaje
        tablasContainer.style.display = 'none';
        logoCentral.style.display = 'block';
        mensajeFinalizacion.style.display = 'block';
        badgeTipo.style.display = 'none';
        
        // Actualizar estado
        infoElement.style.display = 'block';
        infoElement.className = 'status-box status-finalizado';
        infoElement.innerHTML = `
            <div class="text-center">
                <span class="fw-bold"><i class="bi bi-flag-fill"></i> COMPETICIÓN FINALIZADA</span><br>
                <small>Sin actualizaciones en 30 minutos</small>
            </div>`;
    }

    // --- REACTIVAR SISTEMA ---
    function reactivarSistema() {
        console.log('🔄 Reactivando sistema manualmente');
        
        competicionFinalizada = false;
        mensajeFinalizacion.style.display = 'none';
        ultimaActualizacion = Date.now();
        
        // Reiniciar consultas
        iniciarCargaDeResultados();
    }

    async function consultarResultados() {
        if (competicionFinalizada) return;
        
        try {
            const respuesta = await fetch(`https://api.jsonbin.io/v3/b/${DATOS_COMPETICION_BIN_ID}/latest`);
            
            if (!respuesta.ok) {
                throw new Error(`Error de red: ${respuesta.status}`);
            }
            
            const contenidoTexto = await respuesta.text();
            
            // Solo actualizar si hay cambios
            if (contenidoTexto === ultimoContenido) {
                console.log('⏸️ Sin cambios en los datos');
                return;
            }
            
            console.log('🔄 Datos actualizados detectados');
            ultimoContenido = contenidoTexto;
            ultimaActualizacion = Date.now(); // ✅ RESETEAR TIMER

            const datos = JSON.parse(contenidoTexto).record;
            mostrarResultados(datos);
            
        } catch (error) {
            console.error('❌ Error en actualización:', error.message);
            infoElement.style.display = 'block';
            infoElement.className = 'status-box status-disconnected';
            infoElement.innerHTML = `<div class="text-center">⚠️ Error de conexión</div>`;
        }
    }

    // --- FUNCIÓN PARA MOSTRAR RESULTADOS ---
    function mostrarResultados(datos) {
        console.log('📊 Procesando resultados:', datos);
        
        // Guardar disciplina
        disciplinaGuardada = datos.disciplina || 'Resultados en Directo';
        
        if (!datos || !datos.datos) {
            console.warn('⚠️ Formato de datos incorrecto');
            infoElement.style.display = 'block';
            infoElement.className = 'status-box status-disconnected';
            infoElement.innerHTML = `<div class="text-center">❌ Esperando datos de competición...</div>`;
            logoCentral.style.display = 'block';
            tablasContainer.style.display = 'none';
            badgeTipo.style.display = 'none';
            mensajeFinalizacion.style.display = 'none';
            return;
        }
        
        if (datos.datos.length === 0) {
            console.log('⏳ Sin datos de competición aún');
            infoElement.style.display = 'block';
            infoElement.className = 'status-box status-connected';
            infoElement.innerHTML = `
                <div class="text-center">
                    <span class="fw-bold"><i class="bi bi-hourglass-split"></i> ESPERANDO DATOS</span><br>
                    <small>${disciplinaGuardada.toUpperCase()}</small>
                </div>`;
            logoCentral.style.display = 'block';
            tablasContainer.style.display = 'none';
            badgeTipo.style.display = 'none';
            mensajeFinalizacion.style.display = 'none';
            return;
        }
        
        const datosParaTabla = {
            disciplina: disciplinaGuardada,
            tipo: datos.tipo || 'resultado',
            datos: datos.datos
        };

        logoCentral.style.display = 'none';
        mensajeFinalizacion.style.display = 'none';
        tablasContainer.style.display = 'block';
        infoElement.style.display = 'block';
        
        badgeTipo.style.display = 'block';
        if (datosParaTabla.tipo === 'seguimiento') {
            badgeTipo.className = 'badge-tipo badge-seguimiento';
            badgeTipo.textContent = '📊 SEGUIMIENTO';
        } else {
            badgeTipo.className = 'badge-tipo badge-resultado';
            badgeTipo.textContent = '🏆 RESULTADO';
        }
        
        mostrarTablaUnificada(datosParaTabla);
        
        infoElement.className = 'status-box status-connected';
        infoElement.innerHTML = `
            <div class="text-center">
                <span class="fw-bold"><i class="bi bi-check-circle-fill"></i> EN DIRECTO</span><br>
                <small>${disciplinaGuardada.toUpperCase()}</small>
                <div class="contador-actualizacion">Actualizado: ${new Date().toLocaleTimeString()}</div>
            </div>`;
            
        console.log('✅ Resultados mostrados correctamente');
    }

    // --- FUNCIÓN PARA DIBUJAR LA TABLA ---
    function mostrarTablaUnificada(datos) {
        const resultados = datos.datos || [];
        const container = document.getElementById('tablasContainer');
        
        if (!resultados.length) {
            container.innerHTML = `<h2 class="text-center text-warning mt-5">⏳ Esperando resultados...</h2>`;
            return;
        }

        const primerResultado = resultados[0];
        const tieneSeriesIndividuales = primerResultado.series && primerResultado.series.length > 0;
        const tieneParciales = primerResultado.parciales && primerResultado.parciales.length > 0;
        
        const seriesData = tieneSeriesIndividuales ? primerResultado.series : 
                          tieneParciales ? primerResultado.parciales : [];
        const numSeries = seriesData.length;
        
        console.log('📋 Generando tabla con', numSeries, 'columnas');

        let encabezados = '<th>Pos.</th><th>Puesto</th>';
        for (let i = 0; i < numSeries; i++) {
            encabezados += `<th>S${i+1}</th>`;
        }
        encabezados += '<th>Total</th><th>X</th>';

        resultados.sort((a, b) => {
            const puestoA = parseInt(a.puesto) || 0;
            const puestoB = parseInt(b.puesto) || 0;
            return puestoA - puestoB;
        });

        let filas = '';
        resultados.forEach((r, index) => {
            const seriesColumnas = tieneSeriesIndividuales ? r.series : 
                                  tieneParciales ? r.parciales : [];
            
            filas += `
                <tr data-row-index="${index}">
                    <td class="fw-bold text-warning">${index + 1}º</td>
                    <td>Puesto ${r.puesto || '-'}</td>
                    ${seriesColumnas.map(s => `<td>${s !== null && s !== undefined ? s : '-'}</td>`).join('')}
                    <td class="table-success fw-bold">${r.total || 0}</td>
                    <td class="table-info fw-bold">${r.xTotal || 0}</td>
                </tr>
            `;
        });

        const tablaHTML = `
            <div class="resultados-header">${datos.disciplina}</div>
            <div class="table-scroll-wrapper" id="tableScrollWrapper">
                <table class="table table-dark table-bordered table-hover">
                    <thead>
                        <tr>${encabezados}</tr>
                    </thead>
                    <tbody id="tablaBody">
                        ${filas}
                    </tbody>
                </table>
                ${resultados.length > 8 ? '<div class="scroll-indicator" id="scrollIndicator">▼ Más puestos abajo ▼</div>' : ''}
            </div>
        `;
        
        container.innerHTML = tablaHTML;
        
        if (resultados.length > 8) {
            iniciarAutoScroll();
        }
    }
    
    // --- SISTEMA DE AUTO-SCROLL ---
    let autoScrollInterval;
    let scrollDirection = 1;
    let isPaused = false;
    
    function iniciarAutoScroll() {
        if (autoScrollInterval) {
            clearInterval(autoScrollInterval);
        }
        
        const scrollWrapper = document.getElementById('tableScrollWrapper');
        const indicator = document.getElementById('scrollIndicator');
        
        if (!scrollWrapper) return;
        
        scrollWrapper.addEventListener('mouseenter', () => {
            isPaused = true;
        });
        
        scrollWrapper.addEventListener('mouseleave', () => {
            isPaused = false;
        });
        
        scrollWrapper.addEventListener('scroll', () => {
            if (!indicator) return;
            
            const isAtBottom = scrollWrapper.scrollHeight - scrollWrapper.scrollTop <= scrollWrapper.clientHeight + 50;
            const isAtTop = scrollWrapper.scrollTop < 50;
            
            if (isAtBottom) {
                indicator.style.display = 'none';
            } else if (isAtTop && scrollDirection === 1) {
                indicator.style.display = 'block';
                indicator.textContent = '▼ Más puestos abajo ▼';
            }
        });
        
        autoScrollInterval = setInterval(() => {
            if (isPaused) return;
            
            const scrollSpeed = 1.2;
            scrollWrapper.scrollTop += scrollSpeed * scrollDirection;
            
            resaltarFilaCentral();
            
            const isAtBottom = scrollWrapper.scrollHeight - scrollWrapper.scrollTop <= scrollWrapper.clientHeight + 10;
            const isAtTop = scrollWrapper.scrollTop <= 10;
            
            if (isAtBottom) {
                isPaused = true;
                if (indicator) {
                    indicator.textContent = '▲ Volviendo arriba ▲';
                }
                setTimeout(() => {
                    scrollDirection = -1;
                    isPaused = false;
                }, 3000);
            } else if (isAtTop && scrollDirection === -1) {
                isPaused = true;
                if (indicator) {
                    indicator.style.display = 'block';
                    indicator.textContent = '▼ Más puestos abajo ▼';
                }
                setTimeout(() => {
                    scrollDirection = 1;
                    isPaused = false;
                }, 3000);
            }
            
        }, 50);
    }
    
    function resaltarFilaCentral() {
        const scrollWrapper = document.getElementById('tableScrollWrapper');
        const tbody = document.getElementById('tablaBody');
        
        if (!scrollWrapper || !tbody) return;
        
        const filas = tbody.querySelectorAll('tr');
        const wrapperRect = scrollWrapper.getBoundingClientRect();
        const centerY = wrapperRect.top + wrapperRect.height / 2;
        
        filas.forEach(fila => {
            const filaRect = fila.getBoundingClientRect();
            const filaCenterY = filaRect.top + filaRect.height / 2;
            
            if (Math.abs(filaCenterY - centerY) < 50) {
                fila.classList.add('highlight-row');
            } else {
                fila.classList.remove('highlight-row');
            }
        });
    }
    
    window.addEventListener('beforeunload', () => {
        if (intervaloActualizacion) {
            clearInterval(intervaloActualizacion);
        }
        if (intervaloChequeoTimeout) {
            clearInterval(intervaloChequeoTimeout);
        }
        if (autoScrollInterval) {
            clearInterval(autoScrollInterval);
        }
    });
</script>

</body>
</html>
